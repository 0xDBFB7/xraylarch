#!/usr/bin/env python
"""Larch server -- this will make sure a larch server is
running on the desired port.

Usage:  larch_server [OPTIONS] [start|stop|restart|status]

with options
  -p PORT, --port=PORT  port number for remote server [4966]
"""
from __future__ import print_function
__version__ = 'version 1'

import os
import sys
import time
import json
from subprocess import Popen
from optparse import OptionParser
from xmlrpclib import ServerProxy
from larch.xmlrpc_server import (test_server, get_next_port,
                                 NOT_IN_USE, CONNECTED, NOT_LARCHSERVER)

def start_server(port=4966):
    "start server"
    thispath, thisfile = os.path.split(os.path.abspath(__file__))
    args = [sys.executable,
            os.path.join(thispath, 'larch'),
            '-r', '-x', '-p %d' % port]
    return Popen(args)

def get_server(port=4966, host='localhost'):
    "returns server at a port"
    return ServerProxy('http://%s:%d' % (host, port))

def stop_server(port=4966, host='localhost'):
    "stop server"
    server = get_server(port=port, host=host)
    server.shutdown()

usage = "usage: %prog [options] [start|stop|restart|next|status]"

parser = OptionParser(usage=usage, prog="larch_server",
                      version="larch rpc server: %s" % __version__)

parser.add_option("-p", "--port", dest="port", default='4966',
                  metavar='PORT', help="port number for server")

parser.add_option("-q", "--quiet", action="store_true", dest="quiet", default=False,
                  help="suppress screen messages from this launcher script")

parser.add_option("-x", "--nowx", dest="nowx", action="store_true",
                  default=True, help="use wx graphics mode, default=True")

(options, args) = parser.parse_args()

if len(args) == 0:
    args = ['status']

command = args[0]
host = 'localhost'
port = int(options.port)

server_state = test_server(port=port)
premsg = 'Larch server on port %d:' % (port)

def msg(txt):
    if not options.quiet:
        print('%s: %s' % (premsg, txt))

if command == 'start':
    if server_state == CONNECTED:
        msg('already running')
    elif server_state == NOT_IN_USE:
        start_server(port=port)
    else:
        msg('port is in use, cannot start')

elif command == 'stop':
    if server_state == CONNECTED:
        stop_server(port=port)

elif command == 'next':
    port = get_next_port(port=port)
    start_server(port=port)

elif command == 'restart':
    if server_state == CONNECTED:
        stop_server(port=port)

    time.sleep(0.5)
    start_server(port=port)

elif command == 'status':
    if server_state == CONNECTED:
        msg('running')
        sys.exit(0)
    elif server_state == NOT_IN_USE:
        msg('not running')
        sys.exit(1)
    else:
        msg('port is in use by non-larch server')
