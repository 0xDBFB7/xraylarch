<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>XAFS: Fitting XAFS to Feff Paths &mdash; larch 0.9.21 documentation</title>
    
    <link rel="stylesheet" href="../_static/larchdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.9.21',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/sidebar.js"></script>
    <link rel="top" title="larch 0.9.21 documentation" href="../index.html" />
    <link rel="up" title="XAFS Analysis" href="index.html" />
    <link rel="next" title="X-ray Databases" href="../xray/index.html" />
    <link rel="prev" title="XAFS: Reading and using Feff Paths" href="feffpaths.html" /> 
  </head>
  <body>
<div style=" color: #c5daba;  text-align: left; height:100px; padding: 0px">
<table><tr><td width=0></td>
  <td width=25% padding=0>
    <a href="../index.html">
       <img src="../_static/larchcones.png" height=90px alt="larchcones"/>
    </a>
  </td><td width=75% padding=0>
      <font size=+4><a href="../index.html" style="color: #772211">
          Larch: X-ray Data Analysis   </a></font>
</td></tr></table>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../xray/index.html" title="X-ray Databases"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="feffpaths.html" title="XAFS: Reading and using Feff Paths"
             accesskey="P">previous</a> |</li>
   <li><a href="../contents.html">contents</a>|&nbsp;</li>
   <li><a href="../downloads/index.html">downloads</a>|&nbsp;</li>
   <li><a href="../tutorial/index.html">tutorial</a>|&nbsp;</li>
   <li><a href="../data/index.html">data</a>|&nbsp;</li>
   <li><a href="../plotting/index.html">plot</a>|&nbsp;</li>
   <li><a href="../fitting/index.html">fit</a>|&nbsp;</li>
   <li><a href="index.html">XAFS</a>|&nbsp;</li>
   <li><a href="../xray/index.html">Xray Data</a>|&nbsp;</li>
   <li><a href="../xrf/index.html">XRF</a>|&nbsp;</li>

          <li><a href="index.html" accesskey="U">XAFS Analysis</a> &raquo;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">XAFS: Fitting XAFS to Feff Paths</a><ul>
<li><a class="reference internal" href="#the-feffit-strategy-for-modeling-exafs-data">The Feffit Strategy for Modeling EXAFS Data</a></li>
<li><a class="reference internal" href="#fit-statistics-and-goodness-of-fit-meassures-for-feffit">Fit statistics and goodness-of-fit meassures for <tt class="docutils literal"><span class="pre">feffit()</span></tt></a></li>
<li><a class="reference internal" href="#the-feffit-functions-in-larch">The Feffit functions in Larch</a></li>
<li><a class="reference internal" href="#feffit-transform"><tt class="docutils literal"><span class="pre">feffit_transform()</span></tt></a></li>
<li><a class="reference internal" href="#feffit-dataset"><tt class="docutils literal"><span class="pre">feffit_dataset()</span></tt></a></li>
<li><a class="reference internal" href="#feffit"><tt class="docutils literal"><span class="pre">feffit()</span></tt></a></li>
<li><a class="reference internal" href="#feffit-report"><tt class="docutils literal"><span class="pre">feffit_report()</span></tt></a></li>
<li><a class="reference internal" href="#example-1-simple-fit-with-1-path">Example 1: Simple fit with 1 Path</a></li>
<li><a class="reference internal" href="#example-2-fit-1-dataset-with-3-paths">Example 2: Fit 1 dataset with 3 Paths</a></li>
<li><a class="reference internal" href="#example-3-fit-3-datasets-with-1-path-each">Example 3: Fit 3 datasets with 1 Path each</a></li>
<li><a class="reference internal" href="#example-4-measuring-coordination-number">Example 4: Measuring Coordination number</a></li>
<li><a class="reference internal" href="#example-5-comparing-fits-in-different-fit-spaces">Example 5: Comparing Fits in different Fit Spaces</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="feffpaths.html"
                        title="previous chapter">XAFS: Reading and using Feff Paths</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../xray/index.html"
                        title="next chapter">X-ray Databases</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/xafs/feffit.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="module-_xafs">
<span id="xafs-fitting-xafs-to-feff-paths"></span><h1>XAFS: Fitting XAFS to Feff Paths<a class="headerlink" href="#module-_xafs" title="Permalink to this headline">¶</a></h1>
<p>Fitting XAFS data with structural models based on Feff calculations is a
primary motivation for Larch.  In this section, we describe how to set up a
fitting model to fit a set of FEFF calculations to XAFS data.  Many parts
of the documentation so far have touched on important aspects of this
process, and those sections will be referenced here.</p>
<div class="section" id="the-feffit-strategy-for-modeling-exafs-data">
<h2>The Feffit Strategy for Modeling EXAFS Data<a class="headerlink" href="#the-feffit-strategy-for-modeling-exafs-data" title="Permalink to this headline">¶</a></h2>
<p>The basic approach to modeling EXAFS data in Larch <a class="reference internal" href="#newville2001" id="id1">[Newville2001]</a> is to
create a model EXAFS <img class="math" src="../_images/math/bb12e6fe6361a7e793c32820d5b6f2d83e1511d2.png" alt="\chi(k)"/> as a sum of scattering paths that will
be compared to experimentally derived <img class="math" src="../_images/math/bb12e6fe6361a7e793c32820d5b6f2d83e1511d2.png" alt="\chi(k)"/>. The model will
consist of a set of FEFF Scattering Paths representing the photo-electron
scattering from different sets of atoms.  As discussed in
ref:<cite>xafs-feffpaths_sec</cite>, these FEFF Paths have a fixed set of physically
meaningful parameters than can be modified to alter the predicted
contribution to <img class="math" src="../_images/math/bb12e6fe6361a7e793c32820d5b6f2d83e1511d2.png" alt="\chi(k)"/>.  Any of these values can be defined as
algebraic expressions of Larch Parameters defined by <a class="reference internal" href="../fitting/parameters.html#_math.param" title="_math.param"><tt class="xref py py-func docutils literal"><span class="pre">_math.param()</span></tt></a>.
The actual fit uses the same fitting infrastructure as to
<a class="reference internal" href="../fitting/minimize.html#_math.minimize" title="_math.minimize"><tt class="xref py py-func docutils literal"><span class="pre">_math.minimize()</span></tt></a> to refine the values of the variable parameters in
the model so as to best match the experimental data.  Because
<img class="math" src="../_images/math/bb12e6fe6361a7e793c32820d5b6f2d83e1511d2.png" alt="\chi(k)"/> has known properties and <img class="math" src="../_images/math/8c325612684d41304b9751c175df7bcc0f61f64f.png" alt="k"/> dependencies, it is
common to weight and Fourier transform (as described in <a class="reference internal" href="xafsft.html#xafs-ft-sec"><em>XAFS: Fourier Transforms for XAFS</em></a>)
for the analysis.  In general term, the the refinement process will compare
experimental and model <img class="math" src="../_images/math/bb12e6fe6361a7e793c32820d5b6f2d83e1511d2.png" alt="\chi(k)"/> after a <em>Transformation</em>.</p>
<p>The model for <img class="math" src="../_images/math/bb12e6fe6361a7e793c32820d5b6f2d83e1511d2.png" alt="\chi(k)"/> used to compare to data is</p>
<div class="math">
<p><img src="../_images/math/1ea28a56769efb8e2ea35fb08c869efe3635e815.png" alt="\chi(k) = \sum_{j} \chi_{j}(k, p_j)"/></p>
</div><p>where <img class="math" src="../_images/math/05916738ce41f0ee9950287299c77ec134a7da44.png" alt="\chi_j"/> is the EXAFS contribution for a FEFF Path, as given in
<a class="reference internal" href="feffpaths.html#xafs-exafsequation-sec"><em>The EXAFS Equation using Feff and FeffPath Groups</em></a> for path <img class="math" src="../_images/math/8122aa89ea6e80784c6513d22787ad86e36ad0cc.png" alt="j"/>, where <img class="math" src="../_images/math/f0a9cc9827a453a7403b1e5b13bf66527bdbf95b.png" alt="p_j"/> is the
set of adjustable Path Parameters (<img class="math" src="../_images/math/fc923d7c827eca7b3f461463e11c982710c3bcb1.png" alt="S_0^2"/>, <img class="math" src="../_images/math/8a52f40afedf1c8727d71b0ad5a7ea0a7119b088.png" alt="E_0"/>,
<img class="math" src="../_images/math/a6109efe6592ee3e49d34c7e78edb5204535de86.png" alt="\delta{R}"/>, <img class="math" src="../_images/math/741fb9098efcb98055f467f87630a5d0ca599b6b.png" alt="\sigma^2"/>, and so on) listed as <tt class="docutils literal"><span class="pre">Adjustable</span></tt> in
the <a class="reference internal" href="feffpaths.html#xafs-pathparams-table"><em>Table of Feff Path Parameters</em></a>.</p>
<p>The number of FEFF Paths used in the sum can be unlimited, and they do not
need to originate from a single run of FEFF.  This can be important in
modeling even moderately complex structures as a single run of FEFF is
limited to having exactly one absorbing atom in a cluster of atoms and
therefore cannot be used to model multi-site systems without multiple runs.</p>
<p>Because a large number of FEFF Paths could be used to model an XAFS
spectrum, and because each Feff Path has up to 8 adjustable parameters,
there is the potential of having a very large number of parameters for a
fit.  In principle, However, there is a limited amount of information in an
XAFS spectrum.  A simple estimate of how many parameters could be
independently measured is given from information theory of Shannon and
Nyquist as</p>
<div class="math">
<p><img src="../_images/math/24cf73c1d079c99066048fbcd87ec80828c65adb.png" alt="N_{\rm ind} \approx  \frac{2 \Delta k \Delta R}{\pi} + 1"/></p>
</div><p>where <img class="math" src="../_images/math/83db992a1bf9c6721470cff232c7842530571adb.png" alt="\Delta k"/> and <img class="math" src="../_images/math/3b949109c5d7b0ce70c280f17cfc63036d7ccc96.png" alt="\Delta R"/> are the <img class="math" src="../_images/math/8c325612684d41304b9751c175df7bcc0f61f64f.png" alt="k"/> and <img class="math" src="../_images/math/eff43e84f8a3bcf7b6965f0a3248bc4d3a9d0cd4.png" alt="R"/>
range of the usable data under consideration.  E. A. Stern <a class="reference internal" href="#stern1993" id="id2">[Stern1993]</a>
argues convincingly that the &#8216;+1&#8217; here should be &#8216;+2&#8217;, but we&#8217;ll remain
conservative and keep the &#8216;+1&#8217;, and use this value not only for fit
statistics but to limit the maximum number of free variables allowed in a
fit.  In general, this greatly limits the number of parameters thar can be
successfully used in a fit.  It should be noted that this limitation is
inherent in XAFS (and many other techniques that rely on oscillatory
signals), and not a consequence of using Fourier transforms in the
analysis.</p>
<p>Because of this fundamental information limit, it is usual to purposely
limit the spectra being analyzed.  Of course, one usually limits how far
out in energy to measure a signal based on the strength of the signal
compared to some noise level.  This limits the <img class="math" src="../_images/math/8c325612684d41304b9751c175df7bcc0f61f64f.png" alt="k"/> range of useful
data.  In addition, the number of scattering paths that contribute to the
XAFS diverges very quickly with <img class="math" src="../_images/math/eff43e84f8a3bcf7b6965f0a3248bc4d3a9d0cd4.png" alt="R"/>.  For any <img class="math" src="../_images/math/eff43e84f8a3bcf7b6965f0a3248bc4d3a9d0cd4.png" alt="R"/> interval
then, the finite <img class="math" src="../_images/math/8c325612684d41304b9751c175df7bcc0f61f64f.png" alt="k"/> range sets an upper limit on the number of
parameters available for describing the atomic partial pair distribution
function that gives spectral weight in that interval.  The distance to
which a structural model can determined from real XAFS data is therefore
limited to 5 or so Angstroms.  Because of these inherent limitations, it is
generally preferrable to analyze XAFS data by limiting the <img class="math" src="../_images/math/eff43e84f8a3bcf7b6965f0a3248bc4d3a9d0cd4.png" alt="R"/> range
of the analysis by using Fourier transforms to convert <img class="math" src="../_images/math/bb12e6fe6361a7e793c32820d5b6f2d83e1511d2.png" alt="\chi(k)"/> to
<img class="math" src="../_images/math/ed15c000bb99f0b4fabad9eb23e2d7089bc35895.png" alt="\chi(R)"/>.  The <a class="reference internal" href="#_xafs.feffit" title="_xafs.feffit"><tt class="xref py py-func docutils literal"><span class="pre">feffit()</span></tt></a> function allows several choices of
data transformations, including doing 0 (<img class="math" src="../_images/math/8c325612684d41304b9751c175df7bcc0f61f64f.png" alt="k"/>, unfiltered), 1
(<img class="math" src="../_images/math/eff43e84f8a3bcf7b6965f0a3248bc4d3a9d0cd4.png" alt="R"/>, or Fourier transformed), or 2 (math:<cite>q</cite>, or Fourier filtered)
Fourier transforms.   Fitting in unfiltred <img class="math" src="../_images/math/8c325612684d41304b9751c175df7bcc0f61f64f.png" alt="k"/> space is generally not
recommended.</p>
</div>
<div class="section" id="fit-statistics-and-goodness-of-fit-meassures-for-feffit">
<h2>Fit statistics and goodness-of-fit meassures for <a class="reference internal" href="#_xafs.feffit" title="_xafs.feffit"><tt class="xref py py-func docutils literal"><span class="pre">feffit()</span></tt></a><a class="headerlink" href="#fit-statistics-and-goodness-of-fit-meassures-for-feffit" title="Permalink to this headline">¶</a></h2>
<p>The fit done by <a class="reference internal" href="#_xafs.feffit" title="_xafs.feffit"><tt class="xref py py-func docutils literal"><span class="pre">feffit()</span></tt></a> is conceptually very similar to the fits
described in <a class="reference internal" href="../fitting/minimize.html#fitting-minimize-sec"><em>minimize() and Objective Functions</em></a>.   Therefore, many of the
statistics discussed in <a class="reference internal" href="../fitting/results.html#fitting-results-sec"><em>Fit Results and Outputs</em></a> are also generated for
<a class="reference internal" href="#_xafs.feffit" title="_xafs.feffit"><tt class="xref py py-func docutils literal"><span class="pre">feffit()</span></tt></a>. In view of the limited amount of information, some of the
traditional statistical definitions need to be carefully examid, and
possibly altered slightly.   For example, the typical <img class="math" src="../_images/math/a61c1e51680e27d35d05bebed87d474972fc70bd.png" alt="\chi^2"/>
statistic (as given in <a class="reference internal" href="../fitting/overview.html#fitting-overview-sec"><em>Fitting Overview</em></a>) is</p>
<div class="math">
<p><img src="../_images/math/d64cb58349410e9f4b70b840b40b67b17fbea8f0.png" alt="\chi^2 = \sum_{i=1}^{N} \big[\frac{y_i - f(x_i, \vec{\beta})}{\epsilon_i} \big]^2"/></p>
</div><p>seems simple enough, but actually raises several questions, as we have to
decide what each of the terms here is.  As above, we&#8217;ll typically analyze
data in <img class="math" src="../_images/math/eff43e84f8a3bcf7b6965f0a3248bc4d3a9d0cd4.png" alt="R"/> space after a Fourier transform, so that the &#8220;data&#8221;
<img class="math" src="../_images/math/092e364e1d9d19ad5fffb0b46ef4cc7f2da02c1c.png" alt="y"/> actually represents the real and imaginary components of
<img class="math" src="../_images/math/ed15c000bb99f0b4fabad9eb23e2d7089bc35895.png" alt="\chi(R)"/>, and the &#8220;model&#8221; <img class="math" src="../_images/math/bb2c93730dbb48558bb3c4738c956c4e8f816437.png" alt="f"/> will also be the Fourier
transform of the parameterized model for <img class="math" src="../_images/math/bb12e6fe6361a7e793c32820d5b6f2d83e1511d2.png" alt="\chi(k)"/>.</p>
<p>Perhaps the largest questions are ones that are often dismissed as trivial
in standard statistics discussions:</p>
<p>Perhaps surprisingly, the first question is: what is <img class="math" src="../_images/math/fc97ef67268cd4e91bacdf12b8901d7036c9a056.png" alt="N"/>?  The
<img class="math" src="../_images/math/bb12e6fe6361a7e793c32820d5b6f2d83e1511d2.png" alt="\chi(k)"/> data can be measured (or sampled) on an arbitrarily fine
grid, and a Fourier transform can use an arbitrary number of points.  Thus,
the number of points for both <img class="math" src="../_images/math/bb12e6fe6361a7e793c32820d5b6f2d83e1511d2.png" alt="\chi(k)"/> and <img class="math" src="../_images/math/ed15c000bb99f0b4fabad9eb23e2d7089bc35895.png" alt="\chi(R)"/> can
easily be changed without actually changing the quality or quantity of the
real data.  The best number to use for the sum over the number of data
points is then <img class="math" src="../_images/math/3aa620e4e4efc024479fe3505787bfcf905f4212.png" alt="N_{\rm ind}"/> defined above.  Of course, we generally
oversample the data, so the value for <img class="math" src="../_images/math/a61c1e51680e27d35d05bebed87d474972fc70bd.png" alt="\chi^2"/> used and reported is</p>
<div class="math">
<p><img src="../_images/math/652bac7deb963dac3d4924309f91d4291e2ffbc9.png" alt="\chi^2 = \frac{N_{\rm ind}}{N}\sum_{i=1}^{N} \big[\frac{y_i - f(x_i, \vec{\beta})}{\epsilon_i} \big]^2"/></p>
</div><p>where the sum can be over an arbitrary number of samples of <img class="math" src="../_images/math/bb12e6fe6361a7e793c32820d5b6f2d83e1511d2.png" alt="\chi(k)"/>
or <img class="math" src="../_images/math/ed15c000bb99f0b4fabad9eb23e2d7089bc35895.png" alt="\chi(R)"/>, but the actual range of the data sets <img class="math" src="../_images/math/21ca4e531e65d7fa3fae8821733d19efe7e54a72.png" alt="N_{\rm
ind}"/>.</p>
<p>A second consideration is what to use for <img class="math" src="../_images/math/eaf4418fbe935c15a606516d8f55dc380cd8e822.png" alt="\epsilon"/>, the uncertainty
in the &#8220;data&#8221;.  Of course, the uncertainty in the data, <img class="math" src="../_images/math/eaf4418fbe935c15a606516d8f55dc380cd8e822.png" alt="\epsilon"/>,
depends on the details of the data transformation (for example, whether
fitting in <img class="math" src="../_images/math/eff43e84f8a3bcf7b6965f0a3248bc4d3a9d0cd4.png" alt="R"/> or <img class="math" src="../_images/math/0615acc3725de21025457e7d6f7694dab8e2f758.png" alt="q"/> space).  Estimating the noise level in
any given spectrum is not at all trivial, and should generally involve a
proper statistical treatment of the data.  For an individual spectrum, what
can be done easily and automatically is to estimate the noise level
assuming that the data is dominated by noise that is independent of
<img class="math" src="../_images/math/eff43e84f8a3bcf7b6965f0a3248bc4d3a9d0cd4.png" alt="R"/>: white noise.  The function <a class="reference internal" href="utilities.html#_xafs.estimate_noise" title="_xafs.estimate_noise"><tt class="xref py py-func docutils literal"><span class="pre">estimate_noise()</span></tt></a> does this
<a class="reference internal" href="#newvilleboyanovsayers1999" id="id3">[NewvilleBoyanovSayers1999]</a>, and the estimate derived from this method is
used unless you specify a value for <tt class="docutils literal"><span class="pre">epsilon_k</span></tt> the noise level in
<img class="math" src="../_images/math/bb12e6fe6361a7e793c32820d5b6f2d83e1511d2.png" alt="\chi(k)"/>.  Though usually <img class="math" src="../_images/math/eaf4418fbe935c15a606516d8f55dc380cd8e822.png" alt="\epsilon"/> is taken to be a scalar
value, it can be specfied as an array (of the same length as
<img class="math" src="../_images/math/bb12e6fe6361a7e793c32820d5b6f2d83e1511d2.png" alt="\chi(k)"/>) if more accurate measures for the uncertainty of the data
is available.</p>
<p>It turns out that <img class="math" src="../_images/math/a61c1e51680e27d35d05bebed87d474972fc70bd.png" alt="\chi^2"/> is almost always too big, and reduced
<img class="math" src="../_images/math/a2cb6262216c249440689de92d0b2dd75a2f2a96.png" alt="chi^2"/> (that is, <img class="math" src="../_images/math/81cdaed1b9846fe5cd8d4dec86c4155029371476.png" alt="\chi^2/(p - N_{\rm ind})"/> where <img class="math" src="../_images/math/36f73fc1312ee0349b3f3a0f3bd9eb5504339011.png" alt="p"/> is
the number of fitted parameters) is far greater than 1.  This is partly due
to a poor assessment of the uncertainty in the data, and partly due to
imperfections in the calculations that go into the model.  Together, these
are often called &#8220;systematic errors&#8221; in the EXAFS literature.  Because of
this issue, an alternative statistic <img class="math" src="../_images/math/aea4abd525af1cda58b073d556163d0370cb9eae.png" alt="\cal{R}"/> is often used as a
supplement to <img class="math" src="../_images/math/a61c1e51680e27d35d05bebed87d474972fc70bd.png" alt="\chi^2"/> for EXAFS.  The <img class="math" src="../_images/math/aea4abd525af1cda58b073d556163d0370cb9eae.png" alt="\cal{R}"/> factor is
defined as</p>
<div class="math">
<p><img src="../_images/math/716d64c7ac35eaf06fcee3082859f606bde7e08c.png" alt="{\cal{R}} = \frac{\sum_{i=1}^{N} \big[{y_i - f(x_i, \vec{\beta})}\big]^2}{\sum_{i=1}^{N} {y_i^2}}"/></p>
</div><p>which is to say, the misfit scaled by the magnitude of the data.</p>
</div>
<div class="section" id="the-feffit-functions-in-larch">
<h2>The Feffit functions in Larch<a class="headerlink" href="#the-feffit-functions-in-larch" title="Permalink to this headline">¶</a></h2>
<p>The function <a class="reference internal" href="#_xafs.feffit" title="_xafs.feffit"><tt class="xref py py-func docutils literal"><span class="pre">feffit()</span></tt></a> is the principle function to do the fit of a
set of Feff paths to XAFS spectra.  This essentially runs
<a class="reference internal" href="../fitting/minimize.html#_math.minimize" title="_math.minimize"><tt class="xref py py-func docutils literal"><span class="pre">_math.minimize()</span></tt></a> with a parameter group, but with a built-in
objective function to calculate the fit residual.  This built-in objective
function calculates the residual as the difference of model and
experimental <img class="math" src="../_images/math/bb12e6fe6361a7e793c32820d5b6f2d83e1511d2.png" alt="\chi(k)"/> for a list of <em>Datasets</em>.  Here, a <em>Feffit
Dataset</em> is an important concept that will allow us to easily extend
modeling to multiple data sets.</p>
<p>A <em>Feffit Dataset</em> has three principle components.  First, it has an
experimental data, <img class="math" src="../_images/math/bb12e6fe6361a7e793c32820d5b6f2d83e1511d2.png" alt="\chi(k)"/>.  Second, it has a list of Feff paths &#8211;
<a class="reference internal" href="feffpaths.html#_xafs.ff2chi" title="_xafs.ff2chi"><tt class="xref py py-func docutils literal"><span class="pre">ff2chi()</span></tt></a> will be used to calculate the model <img class="math" src="../_images/math/bb12e6fe6361a7e793c32820d5b6f2d83e1511d2.png" alt="\chi(k)"/>.  Third,
it has a <em>Feffit Transform</em> group which holds the Fourier transform and
fitting ranges to select how the data and model are to be compared.  In
addition, a fit has a single parameter group, holding all the variable and
constrained parameters used by all the paths and data sets in a fit.</p>
<p>To be clear, the Path Parameters for all Feff Paths in the fits should be written in terms of
variable parameters help in a single parameter group.</p>
<p>There are then 3 principle functions for setting up and executing
<a class="reference internal" href="#_xafs.feffit" title="_xafs.feffit"><tt class="xref py py-func docutils literal"><span class="pre">feffit()</span></tt></a>:</p>
<blockquote>
<div><ol class="arabic simple">
<li><a class="reference internal" href="#_xafs.feffit_transform" title="_xafs.feffit_transform"><tt class="xref py py-func docutils literal"><span class="pre">feffit_transform()</span></tt></a> is used to create a Transform group,
which holds the set of Fourier transform parameters.</li>
<li><a class="reference internal" href="#_xafs.feffit_dataset" title="_xafs.feffit_dataset"><tt class="xref py py-func docutils literal"><span class="pre">feffit_dataset()</span></tt></a> is used to create a Dataset group, which
consists of the three components described above:<ol class="loweralpha">
<li>a group holding experimental data (<tt class="docutils literal"><span class="pre">k</span></tt> and <tt class="docutils literal"><span class="pre">chi</span></tt>).</li>
<li>a list of Feff paths.</li>
<li>a Transform group.</li>
</ol>
</li>
<li>Finally, <a class="reference internal" href="#_xafs.feffit" title="_xafs.feffit"><tt class="xref py py-func docutils literal"><span class="pre">feffit()</span></tt></a> is run with a parameter group containing
the variable and constrained Parameters for the fit, and a dataset
or list of datasets groups.</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="feffit-transform">
<h2><a class="reference internal" href="#_xafs.feffit_transform" title="_xafs.feffit_transform"><tt class="xref py py-func docutils literal"><span class="pre">feffit_transform()</span></tt></a><a class="headerlink" href="#feffit-transform" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="_xafs.feffit_transform">
<tt class="descclassname">_xafs.</tt><tt class="descname">feffit_transform</tt><big>(</big><em>fitspace='r'</em>, <em>kmin=0</em>, <em>kmax=20</em>, <em>kweight=2</em>, <em>...</em><big>)</big><a class="headerlink" href="#_xafs.feffit_transform" title="Permalink to this definition">¶</a></dt>
<dd><p>create and return Feffit Transform group to be used in a Feffit dataset.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>fitspace</strong> &#8211; name of FT type for fit  (&#8216;r&#8217;).</li>
<li><strong>kmin</strong> &#8211; starting <em>k</em> for FT Window (0).</li>
<li><strong>kmax</strong> &#8211; ending <em>k</em> for FT Window (20).</li>
<li><strong>dk</strong> &#8211; tapering parameter for FT Window (4).</li>
<li><strong>dk2</strong> &#8211; second tapering parameter for FT Window (None).</li>
<li><strong>window</strong> &#8211; name of window type (&#8216;kaiser&#8217;).</li>
<li><strong>nfft</strong> &#8211; value to use for <img class="math" src="../_images/math/182d1a26e1047e88dbb946be3bebe76d50f01a60.png" alt="N_{\rm fft}"/> (2048).</li>
<li><strong>kstep</strong> &#8211; value to use for <img class="math" src="../_images/math/fbdfd51d57bb2c9ba22c27cbd408d65200d28f70.png" alt="\delta{k}"/> (0.05).</li>
<li><strong>kweight</strong> &#8211; exponent for weighting spectra by <img class="math" src="../_images/math/351cfe295a9c1727c0af7a2d3e2cb31984cd439b.png" alt="k^{\rm kweight}"/> (2).</li>
<li><strong>rmin</strong> &#8211; starting <em>R</em> for Fit Range and/or reverse FT Window (0).</li>
<li><strong>rmax</strong> &#8211; ending <em>R</em> for Fit Range and/or reverse FT Window (10).</li>
<li><strong>dr</strong> &#8211; tapering parameter for reverse FT Window 0.</li>
<li><strong>rwindow</strong> &#8211; name of window type for reverse FT Window (&#8216;kaiser&#8217;).</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">a Feffit Transform group</p>
</td>
</tr>
</tbody>
</table>
<p>The parameters stored in the returned group object will be used to
control how the fit is performed.  That is, the Transform group
determines the Fourier transform parameters and fit space for a fit.
All the arguments passed in will be stored as variables of the same
name in the Feffit Transform group.  Additional variables may
be stored in this group as well, once the group has been
used to do some transforms.</p>
</dd></dl>

</div>
<div class="section" id="feffit-dataset">
<h2><a class="reference internal" href="#_xafs.feffit_dataset" title="_xafs.feffit_dataset"><tt class="xref py py-func docutils literal"><span class="pre">feffit_dataset()</span></tt></a><a class="headerlink" href="#feffit-dataset" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="_xafs.feffit_dataset">
<tt class="descclassname">_xafs.</tt><tt class="descname">feffit_dataset</tt><big>(</big><em>data=None</em>, <em>pathlist=</em><span class="optional">[</span><span class="optional">]</span>, <em>transform=None</em><big>)</big><a class="headerlink" href="#_xafs.feffit_dataset" title="Permalink to this definition">¶</a></dt>
<dd><blockquote>
<div><p>create a Feffit Dataset group.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">param data:</th><td class="field-body">group containing experimental EXAFS (needs arrays <tt class="docutils literal"><span class="pre">k</span></tt> and <tt class="docutils literal"><span class="pre">chi</span></tt>).</td>
</tr>
<tr class="field-even field"><th class="field-name">param pathlist:</th><td class="field-body">list of FeffPath groups, as created from <a class="reference internal" href="feffpaths.html#_xafs.feffpath" title="_xafs.feffpath"><tt class="xref py py-func docutils literal"><span class="pre">feffpath()</span></tt></a>.</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">param transform:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body">Feffit Transform group.</td>
</tr>
<tr class="field-even field"><th class="field-name">returns:</th><td class="field-body">a Feffit Dataset group.</td>
</tr>
</tbody>
</table>
<p>A Dataset group is pretty simple, initially consisting of sub-groups <tt class="docutils literal"><span class="pre">data</span></tt>,
<tt class="docutils literal"><span class="pre">pathlist</span></tt>, and <tt class="docutils literal"><span class="pre">transform</span></tt>, though each of these can be complex.</p>
<p>The value for <tt class="docutils literal"><span class="pre">data</span></tt> must be a group containing arrays <tt class="docutils literal"><span class="pre">k</span></tt> and
<tt class="docutils literal"><span class="pre">chi</span></tt> (as determined <a class="reference internal" href="autobk.html#_xafs.autobk" title="_xafs.autobk"><tt class="xref py py-func docutils literal"><span class="pre">_xafs.autobk()</span></tt></a> or some other procedure).
If it contains a value (scalar or array) <tt class="docutils literal"><span class="pre">epsilon_k</span></tt>, that will be
used as the uncertainty in <img class="math" src="../_images/math/bb12e6fe6361a7e793c32820d5b6f2d83e1511d2.png" alt="\chi(k)"/> for weighting the fit.
Otherwise, the uncertainty in <img class="math" src="../_images/math/bb12e6fe6361a7e793c32820d5b6f2d83e1511d2.png" alt="\chi(k)"/> will be estimated
automatically, and stored in this dataset.</p>
<p>The <tt class="docutils literal"><span class="pre">pathlist</span></tt> is a list of Feff Paths, each of which can have its
Path Parameters written in terms of fit parameters (see the final
example in the previous section).  This list of paths will be sent to
<a class="reference internal" href="feffpaths.html#_xafs.ff2chi" title="_xafs.ff2chi"><tt class="xref py py-func docutils literal"><span class="pre">ff2chi()</span></tt></a> to calculate the model <img class="math" src="../_images/math/6dcb9b88aaa5f14312835145edf06fb2d0823c29.png" alt="\chi"/> to compare to the
experimental data.   Finally, <tt class="docutils literal"><span class="pre">transform</span></tt> is a Feffit transform group,
as defined above.</p>
<p>A Dataset will also have a few other components, including:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="23%" />
<col width="77%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">component name</th>
<th class="head">description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>epsilon_k</td>
<td>estimated noise in the <img class="math" src="../_images/math/bb12e6fe6361a7e793c32820d5b6f2d83e1511d2.png" alt="\chi(k)"/> data.</td>
</tr>
<tr class="row-odd"><td>epsilon_r</td>
<td>estimated noise in the <img class="math" src="../_images/math/ed15c000bb99f0b4fabad9eb23e2d7089bc35895.png" alt="\chi(R)"/> data.</td>
</tr>
<tr class="row-even"><td>n_idp</td>
<td>estimated number of independent points in the data.</td>
</tr>
<tr class="row-odd"><td>model</td>
<td>a group for the model <img class="math" src="../_images/math/6dcb9b88aaa5f14312835145edf06fb2d0823c29.png" alt="\chi"/> spectrum.</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div></blockquote>
<p>The <tt class="docutils literal"><span class="pre">model</span></tt> component will be set after a fit, and will contain the
standard set of arrays for <img class="math" src="../_images/math/bb12e6fe6361a7e793c32820d5b6f2d83e1511d2.png" alt="\chi(k)"/> and <img class="math" src="../_images/math/ed15c000bb99f0b4fabad9eb23e2d7089bc35895.png" alt="\chi(R)"/> for the
fitting model, and can be directly compared to the arrays for the
experimental data.</p>
</dd></dl>

</div>
<div class="section" id="feffit">
<h2><a class="reference internal" href="#_xafs.feffit" title="_xafs.feffit"><tt class="xref py py-func docutils literal"><span class="pre">feffit()</span></tt></a><a class="headerlink" href="#feffit" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="_xafs.feffit">
<tt class="descclassname">_xafs.</tt><tt class="descname">feffit</tt><big>(</big><em>paramgroup</em>, <em>datasets</em>, <em>rmax_out=10</em>, <em>path_outputs=True</em><big>)</big><a class="headerlink" href="#_xafs.feffit" title="Permalink to this definition">¶</a></dt>
<dd><p>execute a Feffit fit.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>paramgroup</strong> &#8211; group containing parameters for fit</li>
<li><strong>datasets</strong> &#8211; Feffit Dataset group or list of Feffit Dataset group.</li>
<li><strong>rmax_out</strong> &#8211; maximum <img class="math" src="../_images/math/eff43e84f8a3bcf7b6965f0a3248bc4d3a9d0cd4.png" alt="R"/> value to calculate output arrays.</li>
<li><strong>path_output</strong> &#8211; Flag to set whether all Path outputs should be written.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">a fit results group.</p>
</td>
</tr>
</tbody>
</table>
<p>The <tt class="docutils literal"><span class="pre">paramgroup</span></tt> is a group containing all fitting parameters for the
model.  The <tt class="docutils literal"><span class="pre">datasets</span></tt> argument can be either a single Feffit Dataset
as created by <a class="reference internal" href="#_xafs.feffit_dataset" title="_xafs.feffit_dataset"><tt class="xref py py-func docutils literal"><span class="pre">feffit_dataset()</span></tt></a> or a list of them.  If
<tt class="docutils literal"><span class="pre">path_outputs==True</span></tt>, all Feff Paths in the fit will be separately
Fourier transformed.</p>
<p>When the fit is completed, the returned value will be a group
containing three objects:</p>
<blockquote>
<div><ol class="arabic simple">
<li><tt class="docutils literal"><span class="pre">datasets</span></tt>: an array of FeffitDataSet groups used in the fit.</li>
<li><tt class="docutils literal"><span class="pre">params</span></tt>: This will be identical to the input parameter group.</li>
<li><tt class="docutils literal"><span class="pre">fit</span></tt>: an object which points to the low-level fit.</li>
</ol>
</div></blockquote>
<p>In addition, the output statistics listed below in <a class="reference internal" href="#xafs-feffit-stats-table"><em>Table of
Feffit Output Statistics</em></a>.  will be written
the <tt class="docutils literal"><span class="pre">paramgroup</span></tt> group.  Since each varied and constrained parameter
will also have best-values and estimated uncertainties, this allows the
parameter group to be considered the principle group for a particular
fit &#8211; it holds the variable parameters and statistical results needed
to compare two fits.</p>
<p>On output, a new sub-group called <tt class="docutils literal"><span class="pre">model</span></tt> will be created for each
Feffit Dataset. This will parallel the <tt class="docutils literal"><span class="pre">data</span></tt> group, in the sense
that it will have output arrays listed in the <a class="reference internal" href="#xafs-feffit-arrays-table"><em>Table of Feffit
Output Arrays</em></a>.</p>
<p>If <tt class="docutils literal"><span class="pre">path_outputs==True</span></tt>, all Feff Paths in the fit will be separately
Fourier transformed., with the result being put in the corresponding
FeffPath group.</p>
<p>A final note on the outputs of <a class="reference internal" href="#_xafs.feffit" title="_xafs.feffit"><tt class="xref py py-func docutils literal"><span class="pre">feffit()</span></tt></a>: the <tt class="docutils literal"><span class="pre">param</span></tt> sub-group in
the output is truly identical to the input <tt class="docutils literal"><span class="pre">paramgroup</span></tt>.  It is not a
copy but points to the same group of values (see
<a class="reference internal" href="../tutorial/datatypes.html#tutor-objectids-sec"><em>Object identities, copying, and equality vs. identity</em></a>).</p>
</dd></dl>

<blockquote id="xafs-feffit-stats-table">
<span id="index-0"></span><div><p>Table of Feffit Output Statistics.  These values will be written to the
<tt class="docutils literal"><span class="pre">paramgroup</span></tt> group. Listed here are the group component name and a
description of its content.  Many of these are described in more detail
in <a class="reference internal" href="../fitting/results.html#fitting-results-sec"><em>Fit Results and Outputs</em></a></p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">component name</th>
<th class="head">description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>chi_reduced</td>
<td>reduced chi-square statistic.</td>
</tr>
<tr class="row-odd"><td>chi_square</td>
<td>chi-square statistic.</td>
</tr>
<tr class="row-even"><td>covar</td>
<td>covariance matrix.</td>
</tr>
<tr class="row-odd"><td>covar_vars</td>
<td>list of variable names for rows and columns of covariance matrix.</td>
</tr>
<tr class="row-even"><td>errorbars</td>
<td>Flag whether error bars could be calculated.</td>
</tr>
<tr class="row-odd"><td>fit_details</td>
<td>group with additional fit details.</td>
</tr>
<tr class="row-even"><td>message</td>
<td>output message from fit.</td>
</tr>
<tr class="row-odd"><td>nfree</td>
<td>number of degrees of freedom in fit.</td>
</tr>
<tr class="row-even"><td>nvarys</td>
<td>number of variables in fit.</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div></blockquote>
<blockquote id="xafs-feffit-arrays-table">
<span id="index-1"></span><div><p>Table of Feffit Output Arrays.  The following arrays will be written
into the <tt class="docutils literal"><span class="pre">data</span></tt> and <tt class="docutils literal"><span class="pre">model</span></tt> sub-group for each dataset. The arrays
will be created using the Path Parameters used in the most recent fit
and the Feffit Transform group.  Many of these arrays have names
following the conventions for <a class="reference internal" href="xafsft.html#_xafs.xftf" title="_xafs.xftf"><tt class="xref py py-func docutils literal"><span class="pre">xftf()</span></tt></a> in section on <a class="reference internal" href="xafsft.html#xafs-ft-sec"><em>Fourier
Transforms for XAFS</em></a>.</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">array name</th>
<th class="head">description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>k</td>
<td>wavenumber array of <img class="math" src="../_images/math/8c325612684d41304b9751c175df7bcc0f61f64f.png" alt="k"/>.</td>
</tr>
<tr class="row-odd"><td>chi</td>
<td><img class="math" src="../_images/math/bb12e6fe6361a7e793c32820d5b6f2d83e1511d2.png" alt="\chi(k)"/>.</td>
</tr>
<tr class="row-even"><td>kwin</td>
<td>window <img class="math" src="../_images/math/96353c36e52c43ad8175ee469239c4e6fcbe8230.png" alt="\Omega(k)"/> (length of input chi(k)).</td>
</tr>
<tr class="row-odd"><td>r</td>
<td>uniform array of <img class="math" src="../_images/math/eff43e84f8a3bcf7b6965f0a3248bc4d3a9d0cd4.png" alt="R"/>, out to <tt class="docutils literal"><span class="pre">rmax_out</span></tt>.</td>
</tr>
<tr class="row-even"><td>chir</td>
<td>complex array of <img class="math" src="../_images/math/addf6166115ffd93feb8be6dc7a575e5e6131611.png" alt="\tilde\chi(R)"/>.</td>
</tr>
<tr class="row-odd"><td>chir_mag</td>
<td>magnitude of <img class="math" src="../_images/math/addf6166115ffd93feb8be6dc7a575e5e6131611.png" alt="\tilde\chi(R)"/>.</td>
</tr>
<tr class="row-even"><td>chir_pha</td>
<td>phase of <img class="math" src="../_images/math/addf6166115ffd93feb8be6dc7a575e5e6131611.png" alt="\tilde\chi(R)"/>.</td>
</tr>
<tr class="row-odd"><td>chir_re</td>
<td>real part of <img class="math" src="../_images/math/addf6166115ffd93feb8be6dc7a575e5e6131611.png" alt="\tilde\chi(R)"/>.</td>
</tr>
<tr class="row-even"><td>chir_im</td>
<td>imaginary part of <img class="math" src="../_images/math/addf6166115ffd93feb8be6dc7a575e5e6131611.png" alt="\tilde\chi(R)"/>.</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="feffit-report">
<h2><a class="reference internal" href="#_xafs.feffit_report" title="_xafs.feffit_report"><tt class="xref py py-func docutils literal"><span class="pre">feffit_report()</span></tt></a><a class="headerlink" href="#feffit-report" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="_xafs.feffit_report">
<tt class="descclassname">_xafs.</tt><tt class="descname">feffit_report</tt><big>(</big><em>fit_result</em><big>)</big><a class="headerlink" href="#_xafs.feffit_report" title="Permalink to this definition">¶</a></dt>
<dd><p>return a printable report from a Feffit fit.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>fit_result</strong> &#8211; output group from <a class="reference internal" href="#_xafs.feffit" title="_xafs.feffit"><tt class="xref py py-func docutils literal"><span class="pre">feffit()</span></tt></a>.</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="example-1-simple-fit-with-1-path">
<h2>Example 1: Simple fit with 1 Path<a class="headerlink" href="#example-1-simple-fit-with-1-path" title="Permalink to this headline">¶</a></h2>
<p>We start with a fairly minimal example, fitting spectra read from a data
file with a single Feff Path.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">## examples/feffit/doc_feffit1.lar</span>

<span class="c"># read data</span>
<span class="n">cu_data</span> <span class="o">=</span> <span class="n">read_ascii</span><span class="p">(</span><span class="s">&#39;../xafsdata/cu.chi&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="s">&#39;k, chi&#39;</span><span class="p">)</span>

<span class="c"># define fitting parameter group</span>
<span class="n">pars</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">amp</span>    <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
             <span class="n">del_e0</span> <span class="o">=</span> <span class="n">guess</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
             <span class="n">sig2</span>   <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mf">0.002</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
             <span class="n">del_r</span>  <span class="o">=</span> <span class="n">guess</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span> <span class="p">)</span>

<span class="c"># define a Feff Path, give expressions for Path Parameters</span>
<span class="n">path1</span> <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s">&#39;feffcu01.dat&#39;</span><span class="p">,</span>
                 <span class="n">s02</span>    <span class="o">=</span> <span class="s">&#39;amp&#39;</span><span class="p">,</span>
                 <span class="n">e0</span>     <span class="o">=</span> <span class="s">&#39;del_e0&#39;</span><span class="p">,</span>
                 <span class="n">sigma2</span> <span class="o">=</span> <span class="s">&#39;sig2&#39;</span><span class="p">,</span>
                 <span class="n">deltar</span> <span class="o">=</span> <span class="s">&#39;del_r&#39;</span><span class="p">)</span>

<span class="c"># set tranform / fit ranges</span>
<span class="n">trans</span> <span class="o">=</span> <span class="n">feffit_transform</span><span class="p">(</span><span class="n">kmin</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dk</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="s">&#39;kaiser&#39;</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="mf">1.4</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>

<span class="c"># define dataset to include data, pathlist, transform</span>
<span class="n">dset</span>  <span class="o">=</span> <span class="n">feffit_dataset</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cu_data</span><span class="p">,</span> <span class="n">pathlist</span><span class="o">=</span><span class="p">[</span><span class="n">path1</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>

<span class="c"># perform fit!</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">feffit</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">dset</span><span class="p">)</span>

<span class="k">print</span> <span class="n">feffit_report</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">fout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;doc_feffit1.out&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">feffit_report</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
    <span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&#39;could not write doc_feffit1.lar&#39;</span>
<span class="n">endtry</span>

<span class="n">plot</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>  <span class="n">dset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">chi</span> <span class="o">*</span><span class="n">dset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
     <span class="n">xlabel</span><span class="o">=</span><span class="s">r&#39;$k \rm\,(\AA^{-1})$&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;data&#39;</span><span class="p">,</span>
     <span class="n">ylabel</span><span class="o">=</span><span class="s">r&#39;$k^2\chi(k) \rm\,(\AA^{-2})$&#39;</span><span class="p">,</span>
     <span class="n">title</span><span class="o">=</span><span class="s">&#39;First shell fit to Cu&#39;</span><span class="p">,</span> <span class="n">show_legend</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">dset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">chi</span><span class="o">*</span><span class="n">dset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;fit&#39;</span><span class="p">)</span>

<span class="n">plot</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>  <span class="n">dset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">chir_mag</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
     <span class="n">xlabel</span><span class="o">=</span><span class="s">r&#39;$R \rm\,(\AA)$&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;data&#39;</span><span class="p">,</span>
     <span class="n">ylabel</span><span class="o">=</span><span class="s">r&#39;$|\chi(R)| \rm\,(\AA^{-3})$&#39;</span><span class="p">,</span>
     <span class="n">title</span><span class="o">=</span><span class="s">&#39;First shell fit to Cu&#39;</span><span class="p">,</span> <span class="n">show_legend</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">dset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">chir_mag</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;fit&#39;</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c">## end examples/feffit/doc_feffit1.lar</span>
</pre></div>
</div>
<p>This simply follows the essential steps:</p>
<blockquote>
<div><p>1. A group of parameters <tt class="docutils literal"><span class="pre">pars</span></tt> is defined.  Note that you can include
upper and/or lower bounds and mix the use of <a class="reference internal" href="../fitting/parameters.html#_math.guess" title="_math.guess"><tt class="xref py py-func docutils literal"><span class="pre">_math.guess()</span></tt></a> and
<a class="reference internal" href="../fitting/parameters.html#_math.param" title="_math.param"><tt class="xref py py-func docutils literal"><span class="pre">_math.param()</span></tt></a>.</p>
<p>2. A Feff Path is defined with <a class="reference internal" href="feffpaths.html#_xafs.feffpath" title="_xafs.feffpath"><tt class="xref py py-func docutils literal"><span class="pre">feffpath()</span></tt></a>, as discussed in the
previous section. Here we assign each of the Path Parameters to the name
of one of the fitting parameters.  More complex expressions and relations
can be used, but for this example, we&#8217;re keeping it simple.</p>
<p>3. A Feffit Transform is created with <a class="reference internal" href="#_xafs.feffit_transform" title="_xafs.feffit_transform"><tt class="xref py py-func docutils literal"><span class="pre">feffit_transform()</span></tt></a>, which
essentially sets the Fourier transform parameters and fit ranges.</p>
<p>4. A Feffit Dataset is created with <a class="reference internal" href="#_xafs.feffit_dataset" title="_xafs.feffit_dataset"><tt class="xref py py-func docutils literal"><span class="pre">feffit_dataset()</span></tt></a>.  To begin the
fit, this includes a <tt class="docutils literal"><span class="pre">data</span></tt> group, a <tt class="docutils literal"><span class="pre">transform</span></tt> group, and a
<tt class="docutils literal"><span class="pre">pathlist</span></tt>,  which is a list of FeffPaths.</p>
<p>5. The fit is run with <a class="reference internal" href="#_xafs.feffit" title="_xafs.feffit"><tt class="xref py py-func docutils literal"><span class="pre">feffit()</span></tt></a>, and the output group is saved.
This output group is used by <a class="reference internal" href="#_xafs.feffit_report" title="_xafs.feffit_report"><tt class="xref py py-func docutils literal"><span class="pre">feffit_report()</span></tt></a> to generate a fit
report (shown below).</p>
<p>6. Plots are made from the dataset, using rather long-winded <tt class="xref py py-func docutils literal"><span class="pre">plot()</span></tt>
commands.</p>
</div></blockquote>
<p>running this example prints out the following report:</p>
<div class="highlight-python"><pre>=================== FEFFIT RESULTS ====================
[[Statistics]]
   npts, nvarys, nfree= 104, 4, 100
   chi_square         = 1005.6072
   reduced chi_square = 89.305675
   r-factor           = 0.0028522676
 
[[Data]]
   fit space          = 'r'
   r-range            = 1.400, 3.000
   k-range            = 3.000, 17.000
   k window, dk       = 'kaiser', 4.000
   paths used in fit  = ['feffcu01.dat']
   k-weight           = 2
   epsilon_k          = 0.000150
   epsilon_r          = 0.007111
   n_independent      = 15.260
 
[[Variables]]
   amp            =  0.930915 +/- 0.040101   (init=  1.000000)
   del_e0         =  3.860820 +/- 0.525090   (init=  0.100000)
   del_r          = -0.005996 +/- 0.002679   (init=  0.000000)
   sig2           =  0.008670 +/- 0.000315   (init=  0.002000)
 
[[Correlations]]    (unreported correlations are &lt;  0.100)
   amp, sig2            =  0.929 
   del_e0, del_r        =  0.920 
   del_r, sig2          =  0.159 
   amp, del_r           =  0.137 
 
[[Paths]]
   feff.dat file = feffcu01.dat
          Atom     x        y        z     ipot
           Cu    0.0000,  0.0000,  0.0000  0 (absorber)
           Cu    0.0000, -1.8016,  1.8016  1
     reff   =  2.54780
     Degen  =  12.00000
     S02    =  0.93091 +/-  0.04010
     E0     =  3.86082 +/-  0.52509
     R      =  2.54180 +/-  0.00268
     deltar = -0.00600 +/-  0.00268
     sigma2 =  0.00867 +/-  0.00032

=======================================================</pre>
</div>
<p>and generates the plots shown below</p>
<blockquote id="xafs-fig16">
<div><a class="reference external image-reference" href="../_images/feffit_example1.png"><img alt="../_images/feffit_example1.png" src="../_images/feffit_example1.png" style="width: 48%;" /></a>
<a class="reference external image-reference" href="../_images/feffit_example2.png"><img alt="../_images/feffit_example2.png" src="../_images/feffit_example2.png" style="width: 48%;" /></a>
<p>Figure 16. Results for Feffit for a simple 1-shell fit to a
spectrum from Cu metal.</p>
</div></blockquote>
<p>This is a pretty good fit to the first shell of Cu metal, and shows the
basic mechanics of fitting XAFS data to Feff Paths.  There are several
things that might be added to this for modeling more complex XAFS data,
including adding more paths to a fit, including multiple-scattering paths,
simultaneously modeling more than one data set, and building more complex
fitting models.  We&#8217;ll get to these in the following examples.</p>
<p>But first, a small detour.  The plotting commands in the above example for
plotting <img class="math" src="../_images/math/bb12e6fe6361a7e793c32820d5b6f2d83e1511d2.png" alt="\chi(k)"/> and <img class="math" src="../_images/math/ed15c000bb99f0b4fabad9eb23e2d7089bc35895.png" alt="\chi(R)"/> for data and model will be
useful for the other examples as well, so we&#8217;ll create a slightly
generalized function to make such plots and put this and several other
plotting functions into a separate file, <em>doc_macros.lar</em>.  This will look
like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">## examples/feffit/doc_macros.lar</span>
<span class="c">## general purpose macros, mostly for showing XAFS data</span>
<span class="c">##</span>
<span class="n">label_k</span>     <span class="o">=</span> <span class="s">r&#39;$k \rm\,(\AA^{-1})$&#39;</span>
<span class="n">label_r</span>     <span class="o">=</span> <span class="s">r&#39;$R \rm\,(\AA)$&#39;</span>
<span class="n">label_chikw</span> <span class="o">=</span> <span class="s">r&#39;$k^2\chi(k) \rm\,(\AA^{-</span><span class="si">%i</span><span class="s">})$&#39;</span>
<span class="n">label_chir</span>  <span class="o">=</span> <span class="s">r&#39;$|\chi(R)| \rm\,(\AA^{-</span><span class="si">%i</span><span class="s">})$&#39;</span>
<span class="n">label_chirre</span>  <span class="o">=</span> <span class="s">r&#39;${\rm Re}[\chi(R)] \rm\,(\AA^{-</span><span class="si">%i</span><span class="s">})$&#39;</span>
<span class="n">label_chirim</span>  <span class="o">=</span> <span class="s">r&#39;${\rm Im}[\chi(R)] \rm\,(\AA^{-</span><span class="si">%i</span><span class="s">})$&#39;</span>
<span class="n">label_chirpha</span> <span class="o">=</span> <span class="s">r&#39;${\rm Phase}[\chi(R)] \rm\,(\AA^{-</span><span class="si">%i</span><span class="s">})$&#39;</span>
<span class="k">def</span> <span class="nf">plot_chifit</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">kweight</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>  <span class="n">title</span><span class="o">=</span><span class="s">&#39;Data and Best-Fit&#39;</span><span class="p">,</span>
                <span class="n">win</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">show_legend</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;show chi(k) and chi(r) data and best-fit for a dataset&quot;&quot;&quot;</span>
    <span class="c"># make k-weighted chi(k)</span>
    <span class="n">kw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kweight</span><span class="p">)</span>
    <span class="n">data_chi_kw</span>  <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">chi</span> <span class="o">*</span> <span class="n">dataset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">k</span><span class="o">**</span><span class="n">kw</span>
    <span class="n">model_chi_kw</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">chi</span> <span class="o">*</span> <span class="n">dataset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">k</span><span class="o">**</span><span class="n">kw</span>

    <span class="c"># show k-weighted chi(k) in first plot window</span>
    <span class="n">newplot</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">data_chi_kw</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="n">label_k</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">label_chikw</span> <span class="o">%</span> <span class="n">kw</span><span class="p">,</span>
            <span class="n">show_legend</span><span class="o">=</span><span class="n">show_legend</span><span class="p">,</span>     <span class="n">color</span><span class="o">=</span><span class="s">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;data&#39;</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="n">win</span><span class="p">)</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">model_chi_kw</span><span class="p">,</span>  <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">,</span>  <span class="n">label</span><span class="o">=</span><span class="s">&#39;fit&#39;</span><span class="p">,</span>  <span class="n">win</span><span class="o">=</span><span class="n">win</span><span class="p">)</span>

    <span class="c"># show chi(R) in second plot window</span>
    <span class="n">newplot</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>  <span class="n">dataset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">chir_mag</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">rmax</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="n">label_r</span><span class="p">,</span>  <span class="n">ylabel</span><span class="o">=</span><span class="n">label_chir</span> <span class="o">%</span> <span class="p">(</span><span class="n">kw</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">show_legend</span><span class="o">=</span><span class="n">show_legend</span><span class="p">,</span>              <span class="n">color</span><span class="o">=</span><span class="s">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;data&#39;</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="n">win</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">chir_mag</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">,</span>  <span class="n">label</span><span class="o">=</span><span class="s">&#39;fit&#39;</span><span class="p">,</span>  <span class="n">win</span><span class="o">=</span><span class="n">win</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">chir_re</span><span class="p">,</span>   <span class="n">color</span><span class="o">=</span><span class="s">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>     <span class="n">win</span><span class="o">=</span><span class="n">win</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">chir_re</span><span class="p">,</span>  <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">,</span>  <span class="n">label</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>     <span class="n">win</span><span class="o">=</span><span class="n">win</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">enddef</span>


<span class="k">def</span> <span class="nf">plot_path_k</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">ipath</span><span class="p">,</span> <span class="n">kweight</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
    <span class="s">&quot;plot k-weighted chi(k) for a particular path in a dataset&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">pathlist</span><span class="p">[</span><span class="n">ipath</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s">&#39;path </span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ipath</span><span class="p">)</span>
    <span class="n">endif</span>
    <span class="k">if</span> <span class="n">kweight</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">kweight</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">kweight</span>
    <span class="n">endif</span>
    <span class="n">kw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kweight</span><span class="p">)</span>
    <span class="n">chi_kw</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">path</span><span class="o">.</span><span class="n">chi</span> <span class="o">*</span> <span class="n">path</span><span class="o">.</span><span class="n">k</span><span class="o">**</span><span class="n">kw</span>

    <span class="n">plot</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">chi_kw</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
        <span class="n">xlabel</span><span class="o">=</span><span class="n">label_k</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">label_chikw</span> <span class="o">%</span> <span class="n">kw</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">)</span>

<span class="n">enddef</span>

<span class="k">def</span> <span class="nf">plot_path_r</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">ipath</span><span class="p">,</span> <span class="n">comp</span><span class="o">=</span><span class="s">&#39;mag&#39;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
    <span class="s">&quot;plot chi(r) for a particular path in a dataset&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">pathlist</span><span class="p">[</span><span class="n">ipath</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s">&#39;path </span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ipath</span><span class="p">)</span>
    <span class="n">endif</span>
    <span class="n">kw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">kweight</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">comp</span> <span class="o">==</span> <span class="s">&#39;re&#39;</span><span class="p">:</span>
        <span class="n">chir</span><span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">chir_re</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="n">label_chirre</span> <span class="o">%</span> <span class="n">kw</span>
    <span class="k">elif</span> <span class="n">comp</span> <span class="o">==</span> <span class="s">&#39;im&#39;</span><span class="p">:</span>
        <span class="n">chir</span><span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">chir_im</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="n">label_chirim</span> <span class="o">%</span> <span class="n">kw</span>
    <span class="k">elif</span> <span class="n">comp</span> <span class="o">==</span> <span class="s">&#39;phase&#39;</span><span class="p">:</span>
        <span class="n">chir</span><span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">chir_pha</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="n">label_chirpha</span> <span class="o">%</span> <span class="n">kw</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chir</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">chir_mag</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="n">label_chir</span> <span class="o">%</span> <span class="n">kw</span>
    <span class="n">endif</span>

    <span class="n">chir</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">chir</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">chir</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">label_r</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">)</span>

<span class="n">enddef</span>

<span class="k">def</span> <span class="nf">plot_modelpaths_k</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">kweight</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&#39;Model and Paths&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;show chi(k) for sum and individual paths&quot;&quot;&quot;</span>
    <span class="c"># make k-weighted chi(k)</span>
    <span class="k">if</span> <span class="n">kweight</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">kweight</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">kweight</span>
    <span class="n">endif</span>
    <span class="n">kw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kweight</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">model</span>

    <span class="n">model_chi_kw</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">chi</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">k</span><span class="o">**</span><span class="n">kw</span>

    <span class="n">newplot</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">model_chi_kw</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="n">label_r</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">label_chikw</span> <span class="o">%</span> <span class="n">kw</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;sum&#39;</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ipath</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">pathlist</span><span class="p">)):</span>
        <span class="n">plot_path_k</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">ipath</span><span class="p">,</span> <span class="n">kweight</span><span class="o">=</span><span class="n">kw</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="n">ipath</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">offset</span><span class="p">)</span>
    <span class="n">endfor</span>
<span class="n">enddef</span>

<span class="k">def</span> <span class="nf">plot_modelpaths_r</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">comp</span><span class="o">=</span><span class="s">&#39;mag&#39;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&#39;Model and Paths&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;show chi(r) for sum and individual paths&quot;&quot;&quot;</span>
    <span class="c"># make k-weighted chi(k)</span>
    <span class="n">kw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">kweight</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">model</span>
    <span class="k">if</span> <span class="n">comp</span> <span class="o">==</span> <span class="s">&#39;re&#39;</span><span class="p">:</span>
        <span class="n">chir</span><span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">chir_re</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="n">label_chirre</span> <span class="o">%</span> <span class="n">kw</span>
    <span class="k">elif</span> <span class="n">comp</span> <span class="o">==</span> <span class="s">&#39;im&#39;</span><span class="p">:</span>
        <span class="n">chir</span><span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">chir_im</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="n">label_chirim</span> <span class="o">%</span> <span class="n">kw</span>
    <span class="k">elif</span> <span class="n">comp</span> <span class="o">==</span> <span class="s">&#39;phase&#39;</span><span class="p">:</span>
        <span class="n">chir</span><span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">chir_pha</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="n">label_chirpha</span> <span class="o">%</span> <span class="n">kw</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chir</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">chir_mag</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="n">label_chir</span> <span class="o">%</span> <span class="n">kw</span>
    <span class="n">endif</span>

    <span class="n">newplot</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">chir</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;sum&#39;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">label_r</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ipath</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">pathlist</span><span class="p">)):</span>
        <span class="n">plot_path_r</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">ipath</span><span class="p">,</span> <span class="n">comp</span><span class="o">=</span><span class="n">comp</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="n">ipath</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">offset</span><span class="p">)</span>
    <span class="n">endfor</span>
<span class="n">enddef</span>

<span class="k">def</span> <span class="nf">write_report</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
    <span class="s">&quot;write report to file&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;could not write </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">filename</span>
    <span class="n">endtry</span>
<span class="n">enddef</span>

<span class="c">## end of examples/feffit/doc_macros.lar</span>
</pre></div>
</div>
<p>This defines several new plotting functions <tt class="xref py py-func docutils literal"><span class="pre">plot_chifit()</span></tt>,
<tt class="xref py py-func docutils literal"><span class="pre">plot_path_k()</span></tt>, and <tt class="xref py py-func docutils literal"><span class="pre">plot_path_r()</span></tt>, and so on which we&#8217;ll find
useful in later examples.  Using the first of these, we can then replace
the plot commands in the script above with:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">run</span><span class="p">(</span><span class="s">&#39;doc_macros.lar&#39;</span><span class="p">)</span>
<span class="n">plot_chifit</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&#39;First shell fit to Cu&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>and get reproducible plots without having to copy and paste the same code
fragment everywhere.  We&#8217;ll use this in the examples below.</p>
</div>
<div class="section" id="example-2-fit-1-dataset-with-3-paths">
<h2>Example 2: Fit 1 dataset with 3 Paths<a class="headerlink" href="#example-2-fit-1-dataset-with-3-paths" title="Permalink to this headline">¶</a></h2>
<p>We&#8217;ll continue with the Cu data set, and add more paths to model further
shells.  This is fairly straightforward, but in the interest of space,
we&#8217;ll limit the example here to 3 paths to model the first two shells of
copper.  This is a small step, but highlights a main concern with XAFS
analysis that we need to address.  This is the fact that there simply is
not enough freedom in the XAFS signal to measure all the possible
adjustable Path Parameters independently.  Thus we need to be able to apply
constraints to the Path Parameters.</p>
<p>Here, we use two of the most common types of constraints.  First, we apply
the same amplitude reduction factor and the same <img class="math" src="../_images/math/8a52f40afedf1c8727d71b0ad5a7ea0a7119b088.png" alt="E_0"/> shift to all
Paths.  These may seem obvious for this example, but for more complicated
examples, either including shells of mixed species or Feff Paths generated
from different calculation, these become less obvious.</p>
<p>Second, we introduce a scale the change in distance by a single expansion
factor <img class="math" src="../_images/math/10f32377ac67d94f764f12a15ea987e88c85d3e1.png" alt="\alpha"/> (<tt class="docutils literal"><span class="pre">alpha</span></tt> in the script), and using the built-in
value of half-path distance, <tt class="docutils literal"><span class="pre">reff</span></tt>, and setting <tt class="docutils literal"><span class="pre">deltar</span> <span class="pre">=</span>
<span class="pre">'alpha*reff'</span></tt> for all Paths.  During the calculation of <img class="math" src="../_images/math/bb12e6fe6361a7e793c32820d5b6f2d83e1511d2.png" alt="\chi(k)"/>
for each path that happens in the fitting process, the value of <tt class="docutils literal"><span class="pre">reff</span></tt>
will be updated to the correct value for each path.  Thus, as the value of
<tt class="docutils literal"><span class="pre">alpha</span></tt> varies in the fit, each path will use its proper value for
<tt class="docutils literal"><span class="pre">reff</span></tt>, so that each <tt class="docutils literal"><span class="pre">deltar</span></tt> will be different but not independent.
This ensures that all the path lengths change in a manner consistent with
one another.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">## examples/feffit/doc_feffit2.lar</span>

<span class="c"># read data</span>
<span class="n">cu_data</span> <span class="o">=</span> <span class="n">read_ascii</span><span class="p">(</span><span class="s">&#39;../xafsdata/cu.chi&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="s">&#39;k, chi&#39;</span><span class="p">)</span>

<span class="c"># define fitting parameter group</span>
<span class="n">pars</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">amp</span>    <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
             <span class="n">del_e0</span> <span class="o">=</span> <span class="n">guess</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
             <span class="n">sig2_1</span> <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="o">.</span><span class="mo">002</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
             <span class="n">sig2_2</span> <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="o">.</span><span class="mo">002</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
             <span class="n">sig2_3</span> <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="o">.</span><span class="mo">002</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
             <span class="n">alpha</span>  <span class="o">=</span> <span class="n">guess</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">)</span>

<span class="c"># define 3 Feff Path, give expressions for Path Parameters</span>
<span class="n">path1</span> <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s">&#39;feff0001.dat&#39;</span><span class="p">,</span>     <span class="n">s02</span> <span class="o">=</span> <span class="s">&#39;amp&#39;</span><span class="p">,</span> <span class="n">e0</span> <span class="o">=</span> <span class="s">&#39;del_e0&#39;</span><span class="p">,</span>
                 <span class="n">sigma2</span> <span class="o">=</span> <span class="s">&#39;sig2_1&#39;</span><span class="p">,</span>  <span class="n">deltar</span>  <span class="o">=</span> <span class="s">&#39;alpha*reff&#39;</span><span class="p">)</span>

<span class="n">path2</span> <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s">&#39;feff0002.dat&#39;</span><span class="p">,</span>     <span class="n">s02</span> <span class="o">=</span> <span class="s">&#39;amp&#39;</span><span class="p">,</span> <span class="n">e0</span> <span class="o">=</span> <span class="s">&#39;del_e0&#39;</span><span class="p">,</span>
                 <span class="n">sigma2</span> <span class="o">=</span> <span class="s">&#39;sig2_2&#39;</span><span class="p">,</span>  <span class="n">deltar</span>  <span class="o">=</span> <span class="s">&#39;alpha*reff&#39;</span><span class="p">)</span>

<span class="n">path3</span> <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s">&#39;feff0003.dat&#39;</span><span class="p">,</span>     <span class="n">s02</span> <span class="o">=</span> <span class="s">&#39;amp&#39;</span><span class="p">,</span> <span class="n">e0</span> <span class="o">=</span> <span class="s">&#39;del_e0&#39;</span><span class="p">,</span>
                  <span class="n">sigma2</span> <span class="o">=</span> <span class="s">&#39;sig2_3&#39;</span><span class="p">,</span> <span class="n">deltar</span>  <span class="o">=</span> <span class="s">&#39;alpha*reff&#39;</span><span class="p">)</span>

<span class="n">trans</span> <span class="o">=</span> <span class="n">feffit_transform</span><span class="p">(</span><span class="n">kmin</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dk</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="s">&#39;kaiser&#39;</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="mf">1.4</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mf">3.4</span><span class="p">)</span>

<span class="c"># define dataset to include data, pathlist, transform</span>
<span class="n">dset</span>  <span class="o">=</span> <span class="n">feffit_dataset</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cu_data</span><span class="p">,</span> <span class="n">pathlist</span><span class="o">=</span><span class="p">[</span><span class="n">path1</span><span class="p">,</span> <span class="n">path2</span><span class="p">,</span> <span class="n">path3</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>


<span class="c"># perform fit!</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">feffit</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">dset</span><span class="p">)</span>
<span class="n">report</span> <span class="o">=</span> <span class="n">feffit_report</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="k">print</span> <span class="n">report</span>
<span class="n">run</span><span class="p">(</span><span class="s">&#39;doc_macros.lar&#39;</span><span class="p">)</span>
<span class="n">write_report</span><span class="p">(</span><span class="s">&#39;doc_feffit2.out&#39;</span><span class="p">,</span> <span class="n">report</span><span class="p">)</span>

<span class="n">plot_chifit</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&#39;Three-shell fit to Cu&#39;</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c"># ## end examples/feffit/doc_feffit2.lar</span>
</pre></div>
</div>
<p>Here we simply create <tt class="docutils literal"><span class="pre">path2</span></tt> and <tt class="docutils literal"><span class="pre">path3</span></tt> using nearly the same parameters
as for <tt class="docutils literal"><span class="pre">path1</span></tt>.   Compared to the previous example, the other changes
are that the  <img class="math" src="../_images/math/eff43e84f8a3bcf7b6965f0a3248bc4d3a9d0cd4.png" alt="R"/> range for the fit has been increased so that the
fit will try to fit the second shell, and that  <tt class="docutils literal"><span class="pre">sigma2</span></tt> is allowed to
vary independently for each path.</p>
<p>The output for this fit is a bit longer, being:</p>
<div class="highlight-python"><pre>=================== FEFFIT RESULTS ====================
[[Statistics]]
   npts, nvarys, nfree= 130, 6, 124
   chi_square         = 843.76175
   reduced chi_square = 65.788576
   r-factor           = 0.0023935584
 
[[Data]]
   fit space          = 'r'
   r-range            = 1.400, 3.400
   k-range            = 3.000, 17.000
   k window, dk       = 'kaiser', 4.000
   paths used in fit  = ['feff0001.dat', 'feff0002.dat', 'feff0003.dat']
   k-weight           = 2
   epsilon_k          = 0.000150
   epsilon_r          = 0.007111
   n_independent      = 18.825
 
[[Variables]]
   alpha          = -0.002470 +/- 0.000913   (init=  0.000000)
   amp            =  0.928995 +/- 0.034710   (init=  1.000000)
   del_e0         =  3.821552 +/- 0.453974   (init=  0.100000)
   sig2_1         =  0.008643 +/- 0.000274   (init=  0.002000)
   sig2_2         =  0.014079 +/- 0.001384   (init=  0.002000)
   sig2_3         =  0.008410 +/- 0.003616   (init=  0.002000)
 
[[Correlations]]    (unreported correlations are &lt;  0.100)
   amp, sig2_1          =  0.930 
   alpha, del_e0        =  0.922 
   amp, sig2_3          =  0.239 
   sig2_1, sig2_3       =  0.237 
   amp, sig2_2          =  0.222 
   sig2_1, sig2_2       =  0.208 
   alpha, sig2_1        =  0.179 
   alpha, amp           =  0.159 
   del_e0, sig2_3       =  0.155 
   del_e0, sig2_2       = -0.140 
   alpha, sig2_3        =  0.138 
 
[[Paths]]
   feff.dat file = feff0001.dat
          Atom     x        y        z     ipot
           Cu    0.0000,  0.0000,  0.0000  0 (absorber)
           Cu    0.0000, -1.8016,  1.8016  1
     reff   =  2.54780
     Degen  =  12.00000
     S02    =  0.92899 +/-  0.03471
     E0     =  3.82155 +/-  0.45397
     R      =  2.54151 +/-  0.00075
     deltar = -0.00629 +/-  0.00075
     sigma2 =  0.00864 +/-  0.00027

   feff.dat file = feff0002.dat
          Atom     x        y        z     ipot
           Cu    0.0000,  0.0000,  0.0000  0 (absorber)
           Cu   -3.6032,  0.0000,  0.0000  1
     reff   =  3.60320
     Degen  =  6.00000
     S02    =  0.92899 +/-  0.03471
     E0     =  3.82155 +/-  0.45397
     R      =  3.59430 +/-  0.00106
     deltar = -0.00890 +/-  0.00106
     sigma2 =  0.01408 +/-  0.00138

   feff.dat file = feff0003.dat
          Atom     x        y        z     ipot
           Cu    0.0000,  0.0000,  0.0000  0 (absorber)
           Cu    1.8016, -1.8016,  0.0000  1
           Cu    1.8016,  0.0000, -1.8016  1
     reff   =  3.82180
     Degen  =  48.00000
     S02    =  0.92899 +/-  0.03471
     E0     =  3.82155 +/-  0.45397
     R      =  3.81236 +/-  0.00112
     deltar = -0.00944 +/-  0.00112
     sigma2 =  0.00841 +/-  0.00362

=======================================================</pre>
</div>
<p>With plots of data and fits as shown below.</p>
<blockquote id="xafs-fig17">
<div><a class="reference external image-reference" href="../_images/feffit_example3.png"><img alt="../_images/feffit_example3.png" src="../_images/feffit_example3.png" style="width: 48%;" /></a>
<a class="reference external image-reference" href="../_images/feffit_example4.png"><img alt="../_images/feffit_example4.png" src="../_images/feffit_example4.png" style="width: 48%;" /></a>
<p>Figure 17. Results for Feffit for a 3-shell fit to a spectrum from Cu
metal, constraining all path distances to expand with a single variable.</p>
</div></blockquote>
<p>Here, we show both the magnitude and real part of <img class="math" src="../_images/math/ed15c000bb99f0b4fabad9eb23e2d7089bc35895.png" alt="\chi(R)"/>.  The fit
to the real part shows excellent agreement over the fit <img class="math" src="../_images/math/eff43e84f8a3bcf7b6965f0a3248bc4d3a9d0cd4.png" alt="R"/> range of
[1.4, 3.4] <img class="math" src="../_images/math/9b6bc87a270fc9c4878d7951a4e075ae7bc02c50.png" alt="\AA"/>.  It is often useful the contributions from the
individual paths.  With the macros defined above, this is pretty
straightforward, as we can just do:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">plot_modelpaths_k</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">offset</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plot_modelpaths_r</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">comp</span><span class="o">=</span><span class="s">&#39;re&#39;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
<p>to generate the following plots of the contributions of the different paths:</p>
<blockquote id="xafs-fig18">
<div><a class="reference external image-reference" href="../_images/feffit_example5.png"><img alt="../_images/feffit_example5.png" src="../_images/feffit_example5.png" style="width: 48%;" /></a>
<a class="reference external image-reference" href="../_images/feffit_example6.png"><img alt="../_images/feffit_example6.png" src="../_images/feffit_example6.png" style="width: 48%;" /></a>
<p>Figure 18. Path contributions to full mode for the 3-shell fit to Cu
spectrum.</p>
</div></blockquote>
</div>
<div class="section" id="example-3-fit-3-datasets-with-1-path-each">
<h2>Example 3: Fit 3 datasets with 1 Path each<a class="headerlink" href="#example-3-fit-3-datasets-with-1-path-each" title="Permalink to this headline">¶</a></h2>
<p>We&#8217;ll extend the above example by adding two more data sets.  Since the
three data sets have some things in common, we&#8217;ll be able to use some a
smaller number of total variable parameters for all data sets than if we
had fit each of them individually.  This further allows us to reduce the
number of freely varying parameters in a model of XAFS data, and to better
measure the parameters that are varied.</p>
<p>Here, we&#8217;ll use data on Cu metal measured at three different temperatures.
Since there is no phase change in the material over this temperature range,
the structure changes in small and predictable ways that lends itself to
simple parameterization.  In the interest of brevity, we&#8217;ll only use one
path, but the example could easily be extended to include more paths.</p>
<p>In this example, we have three distinct datasets, so we&#8217;ll have three lists
of paths.  Each of these will have a single path.  Since we&#8217;re modeling
nearly the same structure, the three paths will use the same Feff.dat file
and have many parameters in common, but some parameters will be different
for each data set.  As with the previous example, we use the same amplitude
reduction factor <img class="math" src="../_images/math/8a52f40afedf1c8727d71b0ad5a7ea0a7119b088.png" alt="E_0"/> shift to all data sets.  We allow distances to
vary, but constrain them so that the change is linear in the sample
temperature, as if there were a simple linear expansion in <img class="math" src="../_images/math/eff43e84f8a3bcf7b6965f0a3248bc4d3a9d0cd4.png" alt="R"/>.  To
do this, we set <tt class="docutils literal"><span class="pre">deltar</span> <span class="pre">=</span> <span class="pre">'dr_off</span> <span class="pre">+</span> <span class="pre">T*alpha*reff'</span></tt>, where <tt class="docutils literal"><span class="pre">T</span></tt> is the
temperature for the dataset.  For <img class="math" src="../_images/math/741fb9098efcb98055f467f87630a5d0ca599b6b.png" alt="\sigma^2"/> we&#8217;ll use one of the
built-in models described in <a class="reference internal" href="feffpaths.html#xafs-sigma2calcs-sec"><em>Models for Calculating sigma2</em></a>.  Here we&#8217;ll use <a class="reference internal" href="feffpaths.html#_xafs.sigma2_eins" title="_xafs.sigma2_eins"><tt class="xref py py-func docutils literal"><span class="pre">sigma2_eins()</span></tt></a>, but
<a class="reference internal" href="feffpaths.html#_xafs.sigma2_debye" title="_xafs.sigma2_debye"><tt class="xref py py-func docutils literal"><span class="pre">sigma2_debye()</span></tt></a> can be used as well, and does a better job for
multiple-scattering paths in simple systems.  The model then uses 2
variable parameters for three temperature-dependent distances and 1
variable parameter for three temperature-dependent mean-square
displacements. The full script for the fit looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">## examples/feffit/doc_feffit3.lar</span>

<span class="c"># read 3 datasets</span>
<span class="n">cu_10</span> <span class="o">=</span> <span class="n">read_ascii</span><span class="p">(</span><span class="s">&#39;../xafsdata/cu_10k.xmu&#39;</span><span class="p">)</span>
<span class="n">autobk</span><span class="p">(</span><span class="n">cu_10</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">cu_10</span><span class="o">.</span><span class="n">xmu</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">cu_10</span><span class="p">,</span> <span class="n">rbkg</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">cu_50</span> <span class="o">=</span> <span class="n">read_ascii</span><span class="p">(</span><span class="s">&#39;../xafsdata/cu_50k.xmu&#39;</span><span class="p">)</span>
<span class="n">autobk</span><span class="p">(</span><span class="n">cu_50</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">cu_50</span><span class="o">.</span><span class="n">xmu</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">cu_50</span><span class="p">,</span> <span class="n">rbkg</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">cu_150</span> <span class="o">=</span> <span class="n">read_ascii</span><span class="p">(</span><span class="s">&#39;../xafsdata/cu_150k.xmu&#39;</span><span class="p">)</span>
<span class="n">autobk</span><span class="p">(</span><span class="n">cu_150</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">cu_150</span><span class="o">.</span><span class="n">xmu</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">cu_150</span><span class="p">,</span> <span class="n">rbkg</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c"># define fitting parameter group</span>
<span class="n">pars</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">amp</span>    <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
             <span class="n">del_e0</span> <span class="o">=</span> <span class="n">guess</span><span class="p">(</span><span class="mf">2.0</span><span class="p">),</span>
             <span class="n">theta</span>  <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
             <span class="n">dr_off</span> <span class="o">=</span> <span class="n">guess</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
             <span class="n">alpha</span>  <span class="o">=</span> <span class="n">guess</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">)</span>

<span class="c"># define 3 Feff Path, give expressions for Path Parameters</span>
<span class="n">path1_10</span>  <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s">&#39;feff0001.dat&#39;</span><span class="p">,</span>  <span class="n">s02</span> <span class="o">=</span> <span class="s">&#39;amp&#39;</span><span class="p">,</span> <span class="n">e0</span> <span class="o">=</span> <span class="s">&#39;del_e0&#39;</span><span class="p">,</span>
                     <span class="n">deltar</span> <span class="o">=</span> <span class="s">&#39;dr_off + 10*alpha*reff&#39;</span><span class="p">,</span>
                     <span class="n">sigma2</span> <span class="o">=</span> <span class="s">&#39;sigma2_eins(10, theta)&#39;</span><span class="p">)</span>


<span class="n">path1_50</span>  <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s">&#39;feff0001.dat&#39;</span><span class="p">,</span>  <span class="n">s02</span> <span class="o">=</span> <span class="s">&#39;amp&#39;</span><span class="p">,</span> <span class="n">e0</span> <span class="o">=</span> <span class="s">&#39;del_e0&#39;</span><span class="p">,</span>
                     <span class="n">deltar</span> <span class="o">=</span> <span class="s">&#39;dr_off + 50*alpha*reff&#39;</span><span class="p">,</span>
                     <span class="n">sigma2</span> <span class="o">=</span> <span class="s">&#39;sigma2_eins(50, theta)&#39;</span><span class="p">)</span>

<span class="n">path1_150</span> <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s">&#39;feff0001.dat&#39;</span><span class="p">,</span>  <span class="n">s02</span> <span class="o">=</span> <span class="s">&#39;amp&#39;</span><span class="p">,</span> <span class="n">e0</span> <span class="o">=</span> <span class="s">&#39;del_e0&#39;</span><span class="p">,</span>
                     <span class="n">deltar</span> <span class="o">=</span> <span class="s">&#39;dr_off + 150*alpha*reff&#39;</span><span class="p">,</span>
                     <span class="n">sigma2</span> <span class="o">=</span> <span class="s">&#39;sigma2_eins(150, theta)&#39;</span><span class="p">)</span>

<span class="n">trans</span> <span class="o">=</span> <span class="n">feffit_transform</span><span class="p">(</span><span class="n">kmin</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dk</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="s">&#39;kaiser&#39;</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="mf">1.4</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mf">3.4</span><span class="p">)</span>

<span class="c"># define 3 datasets, each with data, pathlist, transform for each</span>
<span class="n">dset_10</span>   <span class="o">=</span> <span class="n">feffit_dataset</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cu_10</span><span class="p">,</span>  <span class="n">pathlist</span><span class="o">=</span><span class="p">[</span><span class="n">path1_10</span><span class="p">],</span>  <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>
<span class="n">dset_50</span>   <span class="o">=</span> <span class="n">feffit_dataset</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cu_50</span><span class="p">,</span>  <span class="n">pathlist</span><span class="o">=</span><span class="p">[</span><span class="n">path1_50</span><span class="p">],</span>  <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>
<span class="n">dset_150</span>  <span class="o">=</span> <span class="n">feffit_dataset</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cu_150</span><span class="p">,</span> <span class="n">pathlist</span><span class="o">=</span><span class="p">[</span><span class="n">path1_150</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>

<span class="c"># perform fit!</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">feffit</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="p">[</span><span class="n">dset_10</span><span class="p">,</span> <span class="n">dset_50</span><span class="p">,</span> <span class="n">dset_150</span><span class="p">])</span>
<span class="n">report</span> <span class="o">=</span> <span class="n">feffit_report</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="k">print</span> <span class="n">report</span>
<span class="n">run</span><span class="p">(</span><span class="s">&#39;doc_macros.lar&#39;</span><span class="p">)</span>
<span class="n">write_report</span><span class="p">(</span><span class="s">&#39;doc_feffit3.out&#39;</span><span class="p">,</span> <span class="n">report</span><span class="p">)</span>

<span class="n">plot_chifit</span><span class="p">(</span><span class="n">dset_10</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&#39;fit to Cu, 10K&#39;</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plot_chifit</span><span class="p">(</span><span class="n">dset_50</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&#39;fit to Cu, 50K&#39;</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plot_chifit</span><span class="p">(</span><span class="n">dset_150</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&#39;fit to Cu, 150K&#39;</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c"># ## end examples/feffit/doc_feffit3.lar</span>
</pre></div>
</div>
<p>Here we read in 3 datasets for <img class="math" src="../_images/math/adda5391fa04cf4b9e1bdc9b8bf51ddd5bec6977.png" alt="\mu(E)"/> data and do the background
subtraction on each of them.  We define 5 fitting parameters, including the
characteristic (here, Einstein) temperature which will determine the value of
<img class="math" src="../_images/math/741fb9098efcb98055f467f87630a5d0ca599b6b.png" alt="\sigma^2"/>, and two parameters for the linear temperature dependence
of <img class="math" src="../_images/math/eff43e84f8a3bcf7b6965f0a3248bc4d3a9d0cd4.png" alt="R"/>. The output for this fit is:</p>
<div class="highlight-python"><pre>=================== FEFFIT RESULTS ====================
[[Statistics]]
   npts, nvarys, nfree= 390, 5, 385
   chi_square         = 2993.448
   reduced chi_square = 58.152235
   r-factor           = 0.016292904
 
[[Datasets (3)]]
 dataset 1:
   fit space          = 'r'
   r-range            = 1.400, 3.400
   k-range            = 3.000, 17.000
   k window, dk       = 'kaiser', 4.000
   paths used in fit  = ['feff0001.dat']
   k-weight           = 2
   epsilon_k          = 0.000926
   epsilon_r          = 0.044031
   n_independent      = 18.825
 dataset 2:
   fit space          = 'r'
   r-range            = 1.400, 3.400
   k-range            = 3.000, 17.000
   k window, dk       = 'kaiser', 4.000
   paths used in fit  = ['feff0001.dat']
   k-weight           = 2
   epsilon_k          = 0.000842
   epsilon_r          = 0.040021
   n_independent      = 18.825
 dataset 3:
   fit space          = 'r'
   r-range            = 1.400, 3.400
   k-range            = 3.000, 17.000
   k window, dk       = 'kaiser', 4.000
   paths used in fit  = ['feff0001.dat']
   k-weight           = 2
   epsilon_k          = 0.000432
   epsilon_r          = 0.020536
   n_independent      = 18.825
 
[[Variables]]
   alpha          =  0.000011 +/- 0.000007   (init=  0.000000)
   amp            =  0.873512 +/- 0.031297   (init=  1.000000)
   del_e0         =  5.066323 +/- 0.611274   (init=  2.000000)
   dr_off         = -0.001836 +/- 0.002854   (init=  0.000000)
   theta          =  233.039328 +/- 7.557714   (init=  250.000000)
 
[[Correlations]]    (unreported correlations are &lt;  0.100)
   amp, theta           = -0.865 
   del_e0, dr_off       =  0.757 
   alpha, dr_off        = -0.458 
   alpha, del_e0        =  0.110 
 
[[Paths]]
 dataset 1:
   feff.dat file = feff0001.dat
          Atom     x        y        z     ipot
           Cu    0.0000,  0.0000,  0.0000  0 (absorber)
           Cu    0.0000, -1.8016,  1.8016  1
     reff   =  2.54780
     Degen  =  12.00000
     S02    =  0.87351 +/-  0.03130
     E0     =  5.06632 +/-  0.61127
     R      =  2.54624 +/-  0.00102
     deltar = -0.00156 +/-  0.00102
     sigma2 =  0.00328 +/-  0.00004

 dataset 2:
   feff.dat file = feff0001.dat
          Atom     x        y        z     ipot
           Cu    0.0000,  0.0000,  0.0000  0 (absorber)
           Cu    0.0000, -1.8016,  1.8016  1
     reff   =  2.54780
     Degen  =  12.00000
     S02    =  0.87351 +/-  0.03130
     E0     =  5.06632 +/-  0.61127
     R      =  2.54737 +/-  0.00094
     deltar = -0.00043 +/-  0.00094
     sigma2 =  0.00334 +/-  0.00004

 dataset 3:
   feff.dat file = feff0001.dat
          Atom     x        y        z     ipot
           Cu    0.0000,  0.0000,  0.0000  0 (absorber)
           Cu    0.0000, -1.8016,  1.8016  1
     reff   =  2.54780
     Degen  =  12.00000
     S02    =  0.87351 +/-  0.03130
     E0     =  5.06632 +/-  0.61127
     R      =  2.55017 +/-  0.00103
     deltar =  0.00237 +/-  0.00103
     sigma2 =  0.00503 +/-  0.00010

=======================================================</pre>
</div>
<p>Note that an uncertainty is estimated for the Path parameters, including
<tt class="docutils literal"><span class="pre">sigma2</span></tt>, which is calculated with the <a class="reference internal" href="feffpaths.html#_xafs.sigma2_eins" title="_xafs.sigma2_eins"><tt class="xref py py-func docutils literal"><span class="pre">sigma2_eins()</span></tt></a> function.
Such derived uncertainties do reflect the uncertainties and correlations
between variables.  For example, a simplistic evaluation for the standard
error in one of the <tt class="docutils literal"><span class="pre">sigma2</span></tt> parameters using the estimated variance in
the <tt class="docutils literal"><span class="pre">theta</span></tt> might be done as follows:</p>
<div class="highlight-python"><pre>larch&gt; _ave = sigma2_eins(10, pars.theta)
larch&gt; _dlo = sigma2_eins(10, pars.theta-pars.theta.stderr) - _ave
larch&gt; _dhi = sigma2_eins(10, pars.theta+pars.theta.stderr) - _ave
larch&gt; print "sigma2(T=10) = %.5f  (%+.5f, %+.5f)" % (_ave, _dlo, _dhi)
sigma2(T=10) = 0.00328  (+0.00011, -0.00011)</pre>
</div>
<p>This gives an estimate about 3 times larger than the estimate automatically
derived from the fit.  The reason for this is that the simple evaluation
ignores the correlation between parameters, which is taken into account in
the automatically derived uncertainties.  In this case, including this
correlation significantly reduces the estimated uncertainty.</p>
<p>The output plots for the fits to the three datasets are given below.</p>
<blockquote id="xafs-fig19">
<div><a class="reference external image-reference" href="../_images/feffit_3temp1.png"><img alt="../_images/feffit_3temp1.png" src="../_images/feffit_3temp1.png" style="width: 48%;" /></a>
<a class="reference external image-reference" href="../_images/feffit_3temp2.png"><img alt="../_images/feffit_3temp2.png" src="../_images/feffit_3temp2.png" style="width: 48%;" /></a>
<p><strong>a</strong></p>
<a class="reference external image-reference" href="../_images/feffit_3temp3.png"><img alt="../_images/feffit_3temp3.png" src="../_images/feffit_3temp3.png" style="width: 48%;" /></a>
<a class="reference external image-reference" href="../_images/feffit_3temp4.png"><img alt="../_images/feffit_3temp4.png" src="../_images/feffit_3temp4.png" style="width: 48%;" /></a>
<p><strong>b</strong></p>
<a class="reference external image-reference" href="../_images/feffit_3temp5.png"><img alt="../_images/feffit_3temp5.png" src="../_images/feffit_3temp5.png" style="width: 48%;" /></a>
<a class="reference external image-reference" href="../_images/feffit_3temp6.png"><img alt="../_images/feffit_3temp6.png" src="../_images/feffit_3temp6.png" style="width: 48%;" /></a>
<p><strong>c</strong></p>
<p>Figure 19. Fit to Cu metal at (a) 10 K, (b) 50 K, and (c) 150 K, from a
simultaneous fit to all 3 datasets with 5 variables used.</p>
</div></blockquote>
<p>Again, in the interest of brevity and consistency through this chapter,
these example are deliberately simple and meant to be illustrative of the
capabilities and procedures and should not be viewed as limiting the types
of problems that can be modeled.</p>
</div>
<div class="section" id="example-4-measuring-coordination-number">
<h2>Example 4: Measuring Coordination number<a class="headerlink" href="#example-4-measuring-coordination-number" title="Permalink to this headline">¶</a></h2>
<p>For this and the following example, we switch from Cu metal data to data on
a simple metal oxide, FeO.  The structure is a basic rock-salt structure,
and we&#8217;ll model 2 paths for Fe-O and Fe-Fe in this structure.  While the
data is imperfect, we&#8217;ll use it to illustrate a few points in modeling
EXAFS data.</p>
<p>For the examples above with Cu metal, we tacitly assumed that the
coordination number for the different paths was correct, and we adjusted an
<img class="math" src="../_images/math/fc923d7c827eca7b3f461463e11c982710c3bcb1.png" alt="S_0^2"/> parameter.  But, as with many analyses on real systems of
research interest, we&#8217;d like to fit the coordination number for the two
different paths here.  To do this, we set an <img class="math" src="../_images/math/fc923d7c827eca7b3f461463e11c982710c3bcb1.png" alt="S_0^2"/> parameter to a
fixed value, and also force <tt class="docutils literal"><span class="pre">degen</span></tt> (the number of equivalent paths in
the structure used to generate the Feff.dat files) to be 1 for each path.
Instead, we&#8217;ll define parameters <tt class="docutils literal"><span class="pre">n1</span></tt> and <tt class="docutils literal"><span class="pre">n2</span></tt>, and set the Fe-O path&#8217;s
amplitude to be <tt class="docutils literal"><span class="pre">s02*n1</span></tt> and the Fe-Fe path&#8217;s amplitude to be <tt class="docutils literal"><span class="pre">s02*n2</span></tt>.
We&#8217;ll allow <tt class="docutils literal"><span class="pre">n1</span></tt> and <tt class="docutils literal"><span class="pre">n2</span></tt> to vary in the fit, and also define variable
parameters for the other path parameters, including separate variables for
<img class="math" src="../_images/math/3b949109c5d7b0ce70c280f17cfc63036d7ccc96.png" alt="\Delta R"/> and <img class="math" src="../_images/math/741fb9098efcb98055f467f87630a5d0ca599b6b.png" alt="\sigma^2"/>.  The script for this fit is below:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">## examples/feffit/doc_feffit4.lar</span>

<span class="n">feo_dat</span> <span class="o">=</span> <span class="n">read_ascii</span><span class="p">(</span><span class="s">&#39;../xafsdata/feo_xafs.dat&#39;</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="s">&#39;energy xmu&#39;</span><span class="p">)</span>
<span class="n">autobk</span><span class="p">(</span><span class="n">feo_dat</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">feo_dat</span><span class="o">.</span><span class="n">xmu</span><span class="p">,</span> <span class="n">kweight</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">rbkg</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">feo_dat</span><span class="p">)</span>

<span class="c"># define fitting parameter group</span>
<span class="n">pars</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">n1</span>     <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
             <span class="n">n2</span>     <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
             <span class="n">s02</span>    <span class="o">=</span> <span class="mf">0.700</span><span class="p">,</span>
             <span class="n">de0</span>    <span class="o">=</span> <span class="n">guess</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
             <span class="n">sig2_1</span> <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mf">0.002</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
             <span class="n">delr_1</span> <span class="o">=</span> <span class="n">guess</span><span class="p">(</span><span class="mf">0.</span><span class="p">),</span>
             <span class="n">sig2_2</span> <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mf">0.002</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
             <span class="n">delr_2</span> <span class="o">=</span> <span class="n">guess</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>  <span class="p">)</span>

<span class="c"># define Feff Paths, give expressions for Path Parameters</span>
<span class="n">path_feo</span> <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s">&#39;feff_feo01.dat&#39;</span><span class="p">,</span>
                    <span class="n">degen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">s02</span>    <span class="o">=</span> <span class="s">&#39;s02*n1&#39;</span><span class="p">,</span>
                    <span class="n">e0</span>     <span class="o">=</span> <span class="s">&#39;de0&#39;</span><span class="p">,</span>
                    <span class="n">sigma2</span> <span class="o">=</span> <span class="s">&#39;sig2_1&#39;</span><span class="p">,</span>
                    <span class="n">deltar</span> <span class="o">=</span> <span class="s">&#39;delr_1&#39;</span><span class="p">)</span>

<span class="n">path_fefe</span> <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s">&#39;feff_feo02.dat&#39;</span><span class="p">,</span>
                     <span class="n">degen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                     <span class="n">s02</span>    <span class="o">=</span> <span class="s">&#39;s02*n2&#39;</span><span class="p">,</span>
                     <span class="n">e0</span>     <span class="o">=</span> <span class="s">&#39;de0&#39;</span><span class="p">,</span>
                     <span class="n">sigma2</span> <span class="o">=</span> <span class="s">&#39;sig2_2&#39;</span><span class="p">,</span>
                     <span class="n">deltar</span> <span class="o">=</span> <span class="s">&#39;delr_2&#39;</span><span class="p">)</span>

<span class="c"># set tranform / fit ranges</span>
<span class="n">trans</span> <span class="o">=</span> <span class="n">feffit_transform</span><span class="p">(</span><span class="n">kmin</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=</span><span class="mf">13.5</span><span class="p">,</span> <span class="n">kweight</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span>
                         <span class="n">dk</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="n">window</span><span class="o">=</span><span class="s">&#39;kaiser&#39;</span><span class="p">,</span>
                         <span class="n">rmin</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mf">3.2</span><span class="p">,</span> <span class="n">fitspace</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">)</span>

<span class="c"># define dataset to include data, pathlist, transform</span>
<span class="n">dset</span>  <span class="o">=</span> <span class="n">feffit_dataset</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">feo_dat</span><span class="p">,</span> <span class="n">pathlist</span><span class="o">=</span><span class="p">[</span><span class="n">path_feo</span><span class="p">,</span> <span class="n">path_fefe</span><span class="p">],</span>
                       <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">feffit</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">dset</span><span class="p">)</span>
<span class="k">print</span> <span class="n">feffit_report</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="n">run</span><span class="p">(</span><span class="s">&#39;doc_macros.lar&#39;</span><span class="p">)</span>
<span class="n">write_report</span><span class="p">(</span><span class="s">&#39;doc_feffit4.out&#39;</span><span class="p">,</span> <span class="n">feffit_report</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>

<span class="n">plot_chifit</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&#39;Two-path fit to FeO&#39;</span><span class="p">)</span>
<span class="c">## end examples/feffit/doc_feffit4.lar</span>
</pre></div>
</div>
<p>The most important point here is the definitions used in setting up the
amplitudes for the paths:  first, that we set <tt class="docutils literal"><span class="pre">degen</span></tt> to 1, and second
that we used the expression <tt class="docutils literal"><span class="pre">s02*n1</span></tt> and so forth for the value of the
Path&#8217;s amplitude.   A secondary note is that we gave two different
k-weights to <a class="reference internal" href="#_xafs.feffit_transform" title="_xafs.feffit_transform"><tt class="xref py py-func docutils literal"><span class="pre">feffit_transform()</span></tt></a>, which causes both k-weights to be
used in the fit.</p>
<p>The resulting output is</p>
<div class="highlight-python"><pre>=================== FEFFIT RESULTS ====================
[[Statistics]]
   npts, nvarys, nfree= 288, 7, 281
   chi_square         = 532.47218
   reduced chi_square = 52.686214
   r-factor           = 0.011257509
 
[[Data]]
   fit space          = 'r'
   r-range            = 1.000, 3.200
   k-range            = 2.000, 13.500
   k window, dk       = 'kaiser', 3.000
   paths used in fit  = ['feff_feo01.dat', 'feff_feo02.dat']
   k-weight           = 2, 3
   epsilon_k          = 0.000232, 0.000190
   epsilon_r          = 0.006196, 0.057910
   n_independent      = 17.106
 
[[Variables]]
   de0            = -1.465619 +/- 0.770071   (init=  0.100000)
   delr_1         = -0.030443 +/- 0.008582   (init=  0.000000)
   delr_2         =  0.048434 +/- 0.006610   (init=  0.000000)
   n1             =  5.237592 +/- 0.778315   (init=  6.000000)
   n2             =  12.037383 +/- 1.290538   (init=  12.000000)
   sig2_1         =  0.012039 +/- 0.002175   (init=  0.002000)
   sig2_2         =  0.013301 +/- 0.001052   (init=  0.002000)
 
[[Correlations]]    (unreported correlations are &lt;  0.100)
   n2, sig2_2           =  0.935 
   de0, delr_2          =  0.897 
   n1, sig2_1           =  0.886 
   de0, delr_1          =  0.622 
   delr_1, delr_2       =  0.564 
   delr_2, sig2_2       =  0.223 
   delr_2, n2           =  0.215 
   delr_1, sig2_1       =  0.210 
   de0, n1              = -0.209 
   delr_2, n1           = -0.173 
   delr_1, n1           =  0.163 
   de0, sig2_1          = -0.136 
   delr_2, sig2_1       = -0.109 
 
[[Paths]]
   feff.dat file = feff_feo01.dat
          Atom     x        y        z     ipot
           Fe    0.0000,  0.0000,  0.0000  0 (absorber)
           O    0.0000,  2.1387,  0.0000  1
     reff   =  2.13870
     Degen  =  1.00000
     S02    =  3.66631 +/-  0.10332
     E0     = -1.46562 +/-  0.77007
     R      =  2.10826 +/-  0.00858
     deltar = -0.03044 +/-  0.00858
     sigma2 =  0.01204 +/-  0.00218

   feff.dat file = feff_feo02.dat
          Atom     x        y        z     ipot
           Fe    0.0000,  0.0000,  0.0000  0 (absorber)
           Fe    2.1387,  0.0000, -2.1387  2
     reff   =  3.02460
     Degen  =  1.00000
     S02    =  8.42617 +/-  0.17132
     E0     = -1.46562 +/-  0.77007
     R      =  3.07303 +/-  0.00661
     deltar =  0.04843 +/-  0.00661
     sigma2 =  0.01330 +/-  0.00105

=======================================================</pre>
</div>
<p>with plots:</p>
<blockquote id="xafs-fig20">
<div><a class="reference external image-reference" href="../_images/feffit_feo_k.png"><img alt="../_images/feffit_feo_k.png" src="../_images/feffit_feo_k.png" style="width: 48%;" /></a>
<a class="reference external image-reference" href="../_images/feffit_feo_r.png"><img alt="../_images/feffit_feo_r.png" src="../_images/feffit_feo_r.png" style="width: 48%;" /></a>
<p>Figure 20. Fits to 2-path fit to FeO EXAFS.</p>
</div></blockquote>
</div>
<div class="section" id="example-5-comparing-fits-in-different-fit-spaces">
<h2>Example 5: Comparing Fits in different Fit Spaces<a class="headerlink" href="#example-5-comparing-fits-in-different-fit-spaces" title="Permalink to this headline">¶</a></h2>
<p>We now turn to comparing fits in unfiltered k-space, R-space, and filter
k-space (or &#8220;q space&#8221;).  This is partly to illustrate the preference for
using R- or q-space for fitting, and partly to demonstrate how one can run
similar fits and compare the results.  We&#8217;ll use the FeO data from the
previous example.</p>
<p>To change fitting models and transform parameters, we&#8217;ll make copies of the
parameter groups and dataset groups, make a few changes, and re-run the
fits.  For example, we can change the fitting space with (see
examples/feffit/doc_feffit5.lar):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">larch</span><span class="o">&gt;</span> <span class="n">pars2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>   <span class="c"># copy parameters</span>
<span class="n">larch</span><span class="o">&gt;</span> <span class="n">dset2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">dset</span><span class="p">)</span>   <span class="c"># copy dataset</span>
<span class="n">larch</span><span class="o">&gt;</span> <span class="n">dset2</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">fitspace</span> <span class="o">=</span> <span class="s">&#39;q&#39;</span>
</pre></div>
</div>
<p>Now we can run <a class="reference internal" href="#_xafs.feffit" title="_xafs.feffit"><tt class="xref py py-func docutils literal"><span class="pre">feffit()</span></tt></a> with the new parameter group and Dataset
group, and compare the results either by plotting models from the different
copies of the dataset or by viewing the parameter values and fit statistics
with:</p>
<div class="highlight-python"><pre>larch&gt; out2  = feffit(pars2, dset2)
larch&gt; print '*** R Space ***'
larch&gt; print feffit_report(out, with_paths=False, min_correl=0.5)
larch&gt; print '*** Q Space ***'
larch&gt; print feffit_report(out2, with_paths=False, min_correl=0.5)</pre>
</div>
<p>which gives</p>
<div class="highlight-python"><pre>*** R Space***
=================== FEFFIT RESULTS ====================
[[Statistics]]
   npts, nvarys, nfree= 288, 7, 281
   chi_square         = 532.47218
   reduced chi_square = 52.686214
   r-factor           = 0.011257509
 
[[Data]]
   fit space          = 'r'
   r-range            = 1.000, 3.200
   k-range            = 2.000, 13.500
   k window, dk       = 'kaiser', 3.000
   paths used in fit  = ['feff_feo01.dat', 'feff_feo02.dat']
   k-weight           = 2, 3
   epsilon_k          = 0.000232, 0.000190
   epsilon_r          = 0.006196, 0.057910
   n_independent      = 17.106
 
[[Variables]]
   de0            = -1.465619 +/- 0.770071   (init=  0.100000)
   delr_1         = -0.030443 +/- 0.008582   (init=  0.000000)
   delr_2         =  0.048434 +/- 0.006610   (init=  0.000000)
   n1             =  5.237592 +/- 0.778315   (init=  6.000000)
   n2             =  12.037383 +/- 1.290538   (init=  12.000000)
   sig2_1         =  0.012039 +/- 0.002175   (init=  0.002000)
   sig2_2         =  0.013301 +/- 0.001052   (init=  0.002000)
 
[[Correlations]]    (unreported correlations are &lt;  0.500)
   n2, sig2_2           =  0.935 
   de0, delr_2          =  0.897 
   n1, sig2_1           =  0.886 
   de0, delr_1          =  0.622 
   delr_1, delr_2       =  0.564 
=======================================================
*** Q Space***
=================== FEFFIT RESULTS ====================
[[Statistics]]
   npts, nvarys, nfree= 460, 7, 453
   chi_square         = 1292.8609
   reduced chi_square = 127.92395
   r-factor           = 0.0089420565
 
[[Data]]
   fit space          = 'q'
   r-range            = 1.000, 3.200
   k-range            = 2.000, 13.500
   k window, dk       = 'kaiser', 3.000
   paths used in fit  = ['feff_feo01.dat', 'feff_feo02.dat']
   k-weight           = 2, 3
   epsilon_k          = 0.000232, 0.000190
   epsilon_r          = 0.006196, 0.057910
   n_independent      = 17.106
 
[[Variables]]
   de0            = -1.431170 +/- 0.687990   (init= -1.465619)
   delr_1         = -0.030163 +/- 0.007682   (init= -0.030443)
   delr_2         =  0.048810 +/- 0.005911   (init=  0.048434)
   n1             =  5.393483 +/- 0.737246   (init=  5.237592)
   n2             =  12.071760 +/- 1.155595   (init=  12.037383)
   sig2_1         =  0.012425 +/- 0.002008   (init=  0.012039)
   sig2_2         =  0.013332 +/- 0.000940   (init=  0.013301)
 
[[Correlations]]    (unreported correlations are &lt;  0.500)
   n2, sig2_2           =  0.935 
   de0, delr_2          =  0.898 
   n1, sig2_1           =  0.892 
   de0, delr_1          =  0.625 
   delr_1, delr_2       =  0.567 
=======================================================
</pre>
</div>
<p>We can see that the results are not very different &#8211; the best fit values
and uncertainties for the varied parameters are quite close for the fit in
&#8216;R&#8217; space and &#8216;Q&#8217; space.</p>
<p>Now, we can try the fit in unfiltered &#8216;K&#8217; space:</p>
<div class="highlight-python"><pre>larch&gt; pars3 = copy(pars)   # copy parameters
larch&gt; dset3 = copy(dset)   # copy dataset
larch&gt; dset3.transform.kweight = 2
larch&gt; dset3.transform.fitspace = 'k'
larch&gt; out3 = feffit(pars3, dset3)
larch  print feffit_report(out3, with_paths=False, min_correl=0.5)</pre>
</div>
<p>(we need to specify only one k-weight for a k-space fit) which gives:</p>
<div class="highlight-python"><pre>*** K Space***
=================== FEFFIT RESULTS ====================
[[Statistics]]
   npts, nvarys, nfree= 230, 7, 223
   chi_square         = 8585518.8
   reduced chi_square = 849506.32
   r-factor           = 0.11965559
 
[[Data]]
   fit space          = 'k'
   r-range            = 1.000, 3.200
   k-range            = 2.000, 13.500
   k window, dk       = 'kaiser', 3.000
   paths used in fit  = ['feff_feo01.dat', 'feff_feo02.dat']
   k-weight           = 2
   epsilon_k          = 0.000232
   epsilon_r          = 0.006196
   n_independent      = 17.106
 
[[Variables]]
   de0            = -1.326923 +/- 2.134972   (init= -1.465619)
   delr_1         = -0.032974 +/- 0.032155   (init= -0.030443)
   delr_2         =  0.051383 +/- 0.023506   (init=  0.048434)
   n1             =  4.856597 +/- 1.815980   (init=  5.237592)
   n2             =  14.332947 +/- 5.435697   (init=  12.037383)
   sig2_1         =  0.010700 +/- 0.007311   (init=  0.012039)
   sig2_2         =  0.015012 +/- 0.004406   (init=  0.013301)
 
[[Correlations]]    (unreported correlations are &lt;  0.500)
   n2, sig2_2           =  0.920 
   n1, sig2_1           =  0.871 
   de0, delr_2          =  0.847 
   de0, delr_1          =  0.751 
   delr_1, delr_2       =  0.640 
=======================================================
</pre>
</div>
<p>This has pretty similar best-fit values, but dramatically larger estimates
of the errors.  The spectrum is really very poorly fit in k-space because
we have not accounted for the higher R components.  Using R (and Q) space,
we&#8217;re able to limit the R range used in determining the parameter values,
estimated uncertainties, and the goodness-of-fit statistics.  But since we
can&#8217;t place these limits on what portion of the data is being compared to
the model spectra in unfiltered k-space fit, the uncertainties reflect the
fact that the full experimental spectrum is not well model.  This is why it
is recommended to not fit in unfiltered k space: the uncertainties in the
parameters is too large.</p>
<p>Of course, here we&#8217;ve changed only one thing between these three fits &#8211;
the fitting &#8216;space&#8217;.  The process of copying the parameter group and
dataset, making modifications and re-doing fits can also include changing
what parametres are varied, and what constraints are placed between
parameters.</p>
<p class="rubric">References</p>
<table class="docutils citation" frame="void" id="newville2001" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[Newville2001]</a></td><td>M. Newville <em>EXAFS analysis using FEFF and FEFFIT</em>,
J. Synchrotron Radiation,  <strong>8</strong>, pp 96-100, (2001).
[<a class="reference external" href="http://dx.doi.org/10.1107/S0909049500016290">http://dx.doi.org/10.1107/S0909049500016290</a>]</td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="stern1993" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[Stern1993]</a></td><td>E. A. Stern, <em>Number of relevant independent points in
X-ray-absorption fine-structure spectra</em>,
Physical Review <strong>B48</strong>, pp 9825-9827 (1993).
[<a class="reference external" href="http://dx.doi.org/10.1103/PhysRevB.48.9825">http://dx.doi.org/10.1103/PhysRevB.48.9825</a>]</td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="newvilleboyanovsayers1999" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[NewvilleBoyanovSayers1999]</a></td><td>M. Newville, B. Boyanov, and D. E. Sayers,
<em>Estimation of uncertainties in XAFS data</em>,
J. Synchrotron Radiation, <strong>6</strong>, pp 264-265 (1999).
[<a class="reference external" href="http://dx.doi.org/10.1107/S0909049598018147">http://dx.doi.org/10.1107/S0909049598018147</a>]</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../xray/index.html" title="X-ray Databases"
             >next</a> |</li>
        <li class="right" >
          <a href="feffpaths.html" title="XAFS: Reading and using Feff Paths"
             >previous</a> |</li>
   <li><a href="../contents.html">contents</a>|&nbsp;</li>
   <li><a href="../downloads/index.html">downloads</a>|&nbsp;</li>
   <li><a href="../tutorial/index.html">tutorial</a>|&nbsp;</li>
   <li><a href="../data/index.html">data</a>|&nbsp;</li>
   <li><a href="../plotting/index.html">plot</a>|&nbsp;</li>
   <li><a href="../fitting/index.html">fit</a>|&nbsp;</li>
   <li><a href="index.html">XAFS</a>|&nbsp;</li>
   <li><a href="../xray/index.html">Xray Data</a>|&nbsp;</li>
   <li><a href="../xrf/index.html">XRF</a>|&nbsp;</li>

          <li><a href="index.html" >XAFS Analysis</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright Matthew Newville, The University of Chicago, 2012.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>