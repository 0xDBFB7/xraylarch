

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Fitting Overview &mdash; larch 0.9.17 documentation</title>
    
    <link rel="stylesheet" href="../_static/larchdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.9.17',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="larch 0.9.17 documentation" href="../index.html" />
    <link rel="up" title="Fitting and Modeling Data" href="index.html" />
    <link rel="next" title="Parameters" href="parameters.html" />
    <link rel="prev" title="Fitting and Modeling Data" href="index.html" /> 
  </head>
  <body>
<div style=" color: #c5daba;  text-align: left;
            height:100px; padding: 0">
<table><tr>
  <td width=20% padding=0>
    <a href="#">
       <img src="../_static/larchcones.png" width=90% alt="larchcones"/>
    </a>
  </td><td width=80% padding=0>
      <font size=+3><a href="../index.html" style="color: #772211">
          Larch: X-ray Data Analysis   </a></font>
</td></tr></table>
</div>


    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="parameters.html" title="Parameters"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Fitting and Modeling Data"
             accesskey="P">previous</a> |</li>
   <li><a href="../contents.html">contents</a>|&nbsp;</li>
   <li><a href="../installation.html">download</a>|&nbsp;</li>
   <li><a href="../tutorial/index.html">tutorial</a>|&nbsp;</li>
   <li><a href="../data/index.html">data</a>|&nbsp;</li>
   <li><a href="../plotting/index.html">plot</a>|&nbsp;</li>
   <li><a href="index.html">fit</a>|&nbsp;</li>
   <li><a href="../xafs/index.html">XAFS</a>|&nbsp;</li>
   <li><a href="../xray/index.html">Xray Data</a>|&nbsp;</li>
   <li><a href="../xray/xrf.html">XRF</a>|&nbsp;</li>

          <li><a href="index.html" accesskey="U">Fitting and Modeling Data</a> &raquo;</li> 
      </ul>
    </div>


      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Fitting and Modeling Data</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="parameters.html"
                        title="next chapter">Parameters</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/fitting/overview.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="fitting-overview">
<h1>Fitting Overview<a class="headerlink" href="#fitting-overview" title="Permalink to this headline">Â¶</a></h1>
<p>Modeling and fitting of experimental data is a key need for the analysis of
most scientific data.  There is an extensive literature on these topics,
with a wealth written on both the theoretical and practical aspects of
modeling data.  One of the more common and general approaches is to use a
least-squares analysis, in which a parameterized model is adjusted until it
matches experimental data in the sense that the sum of squares of the
difference between data and model is as small as possible.  Mathematically,
this is expressed as</p>
<div class="math">
<p><img src="../_images/math/0e3402960339cb04836c7860942018a3defbf5e0.png" alt="S = \sum_{i=1}^{N} \big[{y_i - f(x_i, \vec{\beta}) } \big]^2"/></p>
</div><p>where the experimental data is expressed as <img class="math" src="../_images/math/cb3e3aafaf565634f3a17951361f66b1ca3609f8.png" alt="y(x)"/> that is discretely
sampled at <img class="math" src="../_images/math/fc97ef67268cd4e91bacdf12b8901d7036c9a056.png" alt="N"/> points, <img class="math" src="../_images/math/e9501ef019c735363acd17c9f8b0ca33266bcaa2.png" alt="f(x, \vec\beta)"/> is a model function of
some dependent data <img class="math" src="../_images/math/26eeb5258ca5099acf8fe96b2a1049c48c89a5e6.png" alt="x"/> and <img class="math" src="../_images/math/d77eda4368d531f5311fc2a379075083186bc068.png" alt="\vec\beta"/>, a set of parameters in the
model.  As a simple example, a linear model of data would be written as
<img class="math" src="../_images/math/39785a1b6a01f4f9aae1cc87fabc4c7de625c9c4.png" alt="f = \beta_0 + \beta_1{x}"/>.  Of course, models can be arbitrary
complex.  There is good statistical justification for using the
least-squares approach, and many existing tools for helping to find the
minimal values of <img class="math" src="../_images/math/ad28c83c99a8fd0dd2e2e594c9d02ee532765a0a.png" alt="S"/>.  These justifcations are not without criticism
or caveats, but we&#8217;ll leave that aside for now.</p>
<p>It is common to include a multiplicative factor to each component in the
least-squares equation above, so that the different samples (or data
points) might be given more or less weight.  Again, there are several
approaches to this, with one of the most common approaches to weight by the
inverse of the estimated uncertainty in the data value.  This then what is
generally called the chi-square goodness-of-fit parameter</p>
<div class="math">
<p><img src="../_images/math/d64cb58349410e9f4b70b840b40b67b17fbea8f0.png" alt="\chi^2 = \sum_{i=1}^{N} \big[\frac{y_i - f(x_i, \vec{\beta})}{\epsilon_i} \big]^2"/></p>
</div><p>Here, <img class="math" src="../_images/math/319593f7ae7122d7910bdf87a156b25f7588f1ad.png" alt="\epsilon_i"/> represents the uncertainty in the value of <img class="math" src="../_images/math/6e6ceb79ebc4bf613298e0144eae25dd73de9be3.png" alt="y_i"/>.
It is common to
As mentioned, the model describing <img class="math" src="../_images/math/0fc7328cefa0b4a249e3f58730e07fa338c056d5.png" alt="f(x, \vec{\beta})"/> can be fairly complex.</p>
<p>There is an extensive literature for case where the model function
<img class="math" src="../_images/math/0fc7328cefa0b4a249e3f58730e07fa338c056d5.png" alt="f(x, \vec{\beta})"/> depends linearly on its parameters
<img class="math" src="../_images/math/f2290e78b38053c14816a9df98eb725d20a4684c.png" alt="\vec{\beta}"/> (but not necessarily linearly on a dependent variable &#8211;
a quadratic function <img class="math" src="../_images/math/bd5917141d61f135b7494d35cc74f9b94cd1bae7.png" alt="\beta_0 + \beta_1 x + \beta_2 x^2"/> is linear in
this sense).  Of course, model function need not be linear in its
parameters, and the minimization is generally referred to a &#8216;&#8217;non-linear
least-squares optimization&#8217;&#8217; in the literature.  All the discussion here
will assume that the models can be non-linear.</p>
<p>It is convenient to define the <strong>residual array</strong> <img class="math" src="../_images/math/b55ca7a0aa88ab7d58f4fc035317fdac39b17861.png" alt="r"/> with <img class="math" src="../_images/math/fc97ef67268cd4e91bacdf12b8901d7036c9a056.png" alt="N"/>
elements:</p>
<div class="math">
<p><img src="../_images/math/4496136c5d130e3df70bbd891d6a63a07d2ebd55.png" alt="r_i = \frac{y_i - f(x_i, \vec\beta)}{\epsilon_i}"/></p>
</div><p>so that the sum to be minimized is a simple sum of this function, <img class="math" src="../_images/math/1f55a748c2d8210ce75719c2aa974062110cda02.png" alt="s
= \sum_i^{N} r_i^2"/>.  The fitting process can then be made very general
with a few key components required.  Specifically, for Larch, the
requirements are</p>
<blockquote>
<div><p>1. A set of Parameters, <img class="math" src="../_images/math/25a40e49dbd538387a0d6c4ab39948d44a945171.png" alt="{\vec{\beta}}"/>, that are used in the model,
and are to be adjusted to find the least-square value of the sum of
squares of the residual.  These must be <strong>parameters</strong> (discussed below)
that are held in a single <strong>parameter group</strong>.  This is a regular Larch
group, and so can contain other values as well.</p>
<p>2. An <strong>objective function</strong> to calculate the residual array.  This
will be a Larch function that takes the <strong>parameter group</strong> described
above as its first argument, and an unlimited set of optional arguments.
The arrays for the data should passed in by these optional arguments.
This function should return the residual array, <img class="math" src="../_images/math/b55ca7a0aa88ab7d58f4fc035317fdac39b17861.png" alt="r"/> that will be
minimized in the least-squares sense.</p>
</div></blockquote>
<p>Note that the use of additional data in the <strong>parameter group</strong> makes this
one way to pass in data to the objective function.  After the fit has
completed, several statistical results describing the fit quality and the
values and uncertainties found for the parameters will be written to thie
<strong>parameter group</strong>.  Though the description so far as been somewhat
formal, the process is not as hard as it sounds, and all the topics
outlined so far will be discussed in more detail below.</p>
<p>Because the objective function will be called by the fitting process, it
needs to follow fairly strict guidelines in its inputs and outputs.
Specifically, the first argument to the function <strong>must</strong> be a Larch group
containing all the Parameters in the model.  Furthermore, the return value
of the objective function must be the fit residual array to be minimized in
the least-squares sense.</p>
<p>We&#8217;ll jump in with a simple example fit to a line, with this script:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># create mock data for a line</span>
<span class="n">dat</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">51</span><span class="p">))</span>
<span class="n">dat</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">dat</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">51</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c"># create a group of fit parameters</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">off</span> <span class="o">=</span> <span class="n">guess</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">slope</span> <span class="o">=</span> <span class="n">guess</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

<span class="n">init</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">off</span> <span class="o">+</span> <span class="n">params</span><span class="o">.</span><span class="n">slope</span> <span class="o">*</span> <span class="n">dat</span><span class="o">.</span><span class="n">x</span>

<span class="c"># define objective function for fit residual</span>
<span class="k">def</span> <span class="nf">fitresid</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">off</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">slope</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
<span class="n">enddef</span>

<span class="c"># perform fit</span>
<span class="n">minimize</span><span class="p">(</span><span class="n">fitresid</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">dat</span><span class="p">,))</span>

<span class="c"># create final model using best-fit values for the parameters.</span>
<span class="n">final</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">off</span> <span class="o">+</span> <span class="n">params</span><span class="o">.</span><span class="n">slope</span> <span class="o">*</span> <span class="n">dat</span><span class="o">.</span><span class="n">x</span>
</pre></div>
</div>
<p>Here <cite>params</cite> is the parameter group, with both <cite>params.off</cite> and
<cite>params.slope</cite> as Parameters that will be adjusted in the fit.  <cite>fitresid</cite>
is the objective function that calculates and returns the residual array
(data - model) from the values of the Parameters.  The <tt class="xref py py-func docutils literal"><span class="pre">minimize()</span></tt>
function does the actual fit, and will call the objective function many
times with different (and generally improving) values for the parameters.
Of course, there are faster and more statistically sound methods for
determining a linear trend in a set of data, but the point of this example
is to illustrate the mechanisms for doing more complex, non-linear modeling
of data.</p>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="parameters.html" title="Parameters"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Fitting and Modeling Data"
             >previous</a> |</li>
   <li><a href="../contents.html">contents</a>|&nbsp;</li>
   <li><a href="../installation.html">download</a>|&nbsp;</li>
   <li><a href="../tutorial/index.html">tutorial</a>|&nbsp;</li>
   <li><a href="../data/index.html">data</a>|&nbsp;</li>
   <li><a href="../plotting/index.html">plot</a>|&nbsp;</li>
   <li><a href="index.html">fit</a>|&nbsp;</li>
   <li><a href="../xafs/index.html">XAFS</a>|&nbsp;</li>
   <li><a href="../xray/index.html">Xray Data</a>|&nbsp;</li>
   <li><a href="../xray/xrf.html">XRF</a>|&nbsp;</li>

          <li><a href="index.html" >Fitting and Modeling Data</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Matthew Newville.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2pre.
    </div>
  </body>
</html>