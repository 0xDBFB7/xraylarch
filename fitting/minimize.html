

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>8.3. minimize() and objective Functions &#8212; larch 0.9.35 documentation</title>
    <link rel="stylesheet" href="../_static/larchdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.9.35',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="8.4. Fit Results and Outputs" href="results.html" />
    <link rel="prev" title="8.2. Parameters" href="parameters.html" />
  <script type="text/x-mathjax-config">
     MathJax.Hub.Config({ "TeX": {Macros: {AA : "{\\unicode{x212B}}"}},
			 "HTML-CSS": {scale: 90}});
  </script>

  </head>
  <body>
<div style=" color: #c5daba;  text-align: left; height:65px; padding: 0px">
<table border=1>
  <tr>
    <td width=20%>
	<a href="../index.html">
	 <img src="../_static/larchcones.png" height=60px alt="larchcones"/></a>
    </td>
    <td width=75% padding=0>
      <font size=+2>
	<a href="../index.html" style="color:#772211">
	  Larch: Data Analysis Tools for X-ray Spectroscopy
	</a>
      </font>
    </td>
   </tr></table>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="results.html" title="8.4. Fit Results and Outputs"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="parameters.html" title="8.2. Parameters"
             accesskey="P">previous</a> |</li>
   <li>[<a href="../data/index.html">Reading Data</a>|</li>
   <li><a href="../plotting/index.html">Plotting</a>|</li>
   <li><a href="index.html">Fitting Data</a>|</li>
   <li><a href="../xafs/index.html">XAFS Analysis</a>|</li>
   <li><a href="../xray/index.html">Xray Databases</a>|</li>
   <li><a href="../xrf/index.html">XRF Analysis</a>|</li>
   <li><a href="../devel/index.html">Scripting</a>]</li>

          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">8. Fitting and Modeling Data</a> &#187;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="parameters.html"
                        title="previous chapter">8.2. Parameters</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="results.html"
                        title="next chapter">8.4. Fit Results and Outputs</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/fitting/minimize.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="module-_math">
<span id="minimize-and-objective-functions"></span><span id="fitting-minimize-sec"></span><h1>8.3. <code class="xref py py-func docutils literal"><span class="pre">minimize()</span></code> and objective Functions<a class="headerlink" href="#module-_math" title="Permalink to this headline">¶</a></h1>
<p>As mentioned above, the objective function returns an array calculated from
given a group of parameters.  This array will be minimized in the
least-squares sense in the fitting process.  For most fits, the objective
function should return the residual array (data - model), given a group of
parameters and optional inputs.  You’ll note that we didn’t explicitly
mention any <em>data</em> in describing the objective function.  This is because,
formally, the minimization process may be looking for a solution to a
purely mathematical problem, not just fitting to data.  Even when the
objective function does return the difference of data and model, the data
to be modeled may be quite complex.  It might, for example, be contained in
two or more arrays – perhaps what you want to model is the difference of
two image arrays, or the fourier filtered average of ten spectra.  Because
of such complexities, the reliance of optional arguments appears to be the
best approach.</p>
<p id="index-0">A simple objective function that models data as a line might look like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="n">param_group</span><span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                     <span class="n">slope</span> <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">residual</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">xdata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">pars</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">pars</span><span class="o">.</span><span class="n">slope</span> <span class="o">*</span> <span class="n">xdata</span>
    <span class="n">diff</span>  <span class="o">=</span> <span class="n">ydata</span> <span class="o">-</span> <span class="n">model</span>
    <span class="k">return</span> <span class="n">diff</span>
<span class="n">enddef</span>
</pre></div>
</div>
<p>Here <code class="docutils literal"><span class="pre">params</span></code> is a Group containing two Parameters as defined by
<a class="reference internal" href="parameters.html#_math.param" title="_math.param"><code class="xref py py-func docutils literal"><span class="pre">_math.param()</span></code></a>, discussed earlier.</p>
<p>To actually perform the fit, the <a class="reference internal" href="#_math.minimize" title="_math.minimize"><code class="xref py py-func docutils literal"><span class="pre">minimize()</span></code></a> function must be
called.  This takes the objective function as its first argument, and
the group containing all the Parameters as its second argument,
keyword arguments for the optional arguments for the objective
function, and several keyword arguments to alter the fitting process
itself.  Here is the function call using the objective function
defined above, assuming you have a group called <code class="docutils literal"><span class="pre">data</span></code> containing
the data you are trying to fit:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">residual</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;xdata&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;ydata&#39;</span><span class="p">:</span><span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="p">})</span>
</pre></div>
</div>
<p>As the fit proceeds, the values the Parameter values will be updated, and
the objective function will be called to recalculate the residual array.
Thus the objective function may be called many times before the fitting
procedure decides it has found the best solution that it can.</p>
<div class="versionchanged">
<p><span class="versionmodified">Changed in version 0.9.34: </span><a class="reference internal" href="#_math.minimize" title="_math.minimize"><code class="xref py py-func docutils literal"><span class="pre">minimize()</span></code></a> returns a result group containing fit statistics.</p>
</div>
<dl class="function">
<dt id="_math.minimize">
<code class="descclassname">_math.</code><code class="descname">minimize</code><span class="sig-paren">(</span><em>fcn</em>, <em>paramgroup</em>, <em>args=None</em>, <em>kws=None</em>, <em>method='leastsq'</em>, <em>**extra_kws</em><span class="sig-paren">)</span><a class="headerlink" href="#_math.minimize" title="Permalink to this definition">¶</a></dt>
<dd><p>find the best-fit values for the Parameters in <code class="docutils literal"><span class="pre">paramgroup</span></code> such that the
output array from the objective function <code class="xref py py-func docutils literal"><span class="pre">fcn()</span></code> has minimal sum-of-squares.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>fcn</strong> – objective function, which must have signature and output as described below.</li>
<li><strong>paramgroup</strong> – a Group containing the Parameters used by the
objective function. This will be passed as the first argument to the
objective function.  The Group can contain other components in
addition to the set of Parameters for the model.</li>
<li><strong>args</strong> – a tuple of positional arguments to pass to the
objective function.  Note that a single argument tuple
is constructed by following a value with a comma (it
is not sufficient to enclose a single value in
parentheses)</li>
<li><strong>kws</strong> – a dictionary of keyword/value arguments to pass to the objective function.</li>
<li><strong>method</strong> – name (case insensitive) of minimization method to use (default=’leastsq’)</li>
<li><strong>extra_kws</strong> – additional keywords to pass to fitting method.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">a Group containing several fitting statisics and best-fit parameters.</p>
</td>
</tr>
</tbody>
</table>
<p>The <code class="docutils literal"><span class="pre">method</span></code> argument gives the name of the fitting method to be
used.  Several methods are available, as described below in
<a class="reference internal" href="#minimize-methods-table"><span class="std std-ref">Table of Fitting Methods</span></a>.</p>
</dd></dl>

<blockquote id="minimize-methods-table">
<div><p>Table of Fitting Methods.</p>
<p>Listed are the names and description of fitting methods available to the
<a class="reference internal" href="#_math.minimize" title="_math.minimize"><code class="xref py py-func docutils literal"><span class="pre">minimize()</span></code></a> function.  The <em>leastsq</em> method is the default, and the
only method for which uncertainties and correlations are automatically
calculated.</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="16%" />
<col width="84%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">method name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Leastsq</td>
<td>Levenberg-Marquardt.</td>
</tr>
<tr class="row-odd"><td>Nelder-Mead</td>
<td>Nelder-Mead downhill simplex.</td>
</tr>
<tr class="row-even"><td>Powell</td>
<td>Powell’s method.</td>
</tr>
<tr class="row-odd"><td>BFGS</td>
<td>quasi-Newton method of Broyden, Fletcher, Goldfarb, and Shanno.</td>
</tr>
<tr class="row-even"><td>CG</td>
<td>Conjugate Gradient.</td>
</tr>
<tr class="row-odd"><td>LBFGSB</td>
<td>Limited-Memory BFGS Method with Constraints.</td>
</tr>
<tr class="row-even"><td>TNC</td>
<td>Truncated Newton method.</td>
</tr>
<tr class="row-odd"><td>COBYLA</td>
<td>Constrained Optimization BY Linear Approximation.</td>
</tr>
<tr class="row-even"><td>SLSQP</td>
<td>Sequential Least SQuares Programming.</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div></blockquote>
<p>Further information on these methods, including full lists of extra
parameters that can be passed to them, can be found at
<a class="reference external" href="https://lmfit.github.io/lmfit-py/fitting.html">lmfit.fitting</a>.</p>
<p>It should be noted that the Levenberg-Marquardt algorithm is almost always
the fastest of the methods listed (often by 10x), and is generally fairly
robust.  It is sometimes criticized as being sensitive to initial guesses
and prone to finding local minima.  The other fitting methods use very
different algorithms, and so can be used to explore these effects. Many of
them are much slower – using more than ten times as many evaluations of
the objective function is not unusual. This does not guarantee a more
robust answer, but it does allow one to try out and compare the results of
the different methods.</p>
<p>While the TNC, COBYLA, SLSQP, and LBFGSB methods are supported, their
principle justification is that the underlying algorithms support
constraints.  For Larch, this advantage is not particularly important, as
all fitting methods can have constraints applied through Parameters, and
the mechanism used by the native methods is not actually even supported
with Larch.  That said, all these methods are still interesting to explore.</p>
<p>Extra keywords for the <em>leastsq</em> method include:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="22%" />
<col width="16%" />
<col width="61%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><code class="docutils literal"><span class="pre">extra_kw</span></code> arg for
<code class="docutils literal"><span class="pre">method='leastsq'</span></code></th>
<th class="head">Default Value</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>xtol</td>
<td>1.e-7</td>
<td>Relative error in the approximate solution</td>
</tr>
<tr class="row-odd"><td>ftol</td>
<td>1.e-7</td>
<td>Relative error in the desired sum of squares</td>
</tr>
<tr class="row-even"><td>maxfev</td>
<td>2000*(nvar+1)</td>
<td>maximum number of function calls (nvar= # of variables)</td>
</tr>
<tr class="row-odd"><td>Dfun</td>
<td><code class="docutils literal"><span class="pre">None</span></code></td>
<td>function to call for Jacobian calculation</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>By default, numerical derivatives are used, and the following arguments are
used.</p>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="results.html" title="8.4. Fit Results and Outputs"
             >next</a> |</li>
        <li class="right" >
          <a href="parameters.html" title="8.2. Parameters"
             >previous</a> |</li>
   <li>[<a href="../data/index.html">Reading Data</a>|</li>
   <li><a href="../plotting/index.html">Plotting</a>|</li>
   <li><a href="index.html">Fitting Data</a>|</li>
   <li><a href="../xafs/index.html">XAFS Analysis</a>|</li>
   <li><a href="../xray/index.html">Xray Databases</a>|</li>
   <li><a href="../xrf/index.html">XRF Analysis</a>|</li>
   <li><a href="../devel/index.html">Scripting</a>]</li>

          <li class="nav-item nav-item-1"><a href="index.html" >8. Fitting and Modeling Data</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright Matthew Newville, The University of Chicago, 2012.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.3.
    </div>
  </body>
</html>